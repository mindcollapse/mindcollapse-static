<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">

    <title>Продолжаем копать HTML5: Comet, WebSockets, EventSource, NodeJS</title> 

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="jm8IGIWg4dsm0cTmih0sIVnUaWibc_hpOiQOlqb--9Y"> 
    <meta name="yandex-verification" content="4b85f46617ab1114"> 
    <meta name="y_key" content="04bed234d6a405cc"> 
    <meta name="msvalidate.01" content="62188F55275960794DDFA698C3EA9F05">

    <link rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.ru">
    <link rel="sitemap" href="https://www.mindcollapse.com/blog/sitemap.xml">

    
        <link rel="canonical" href="https://www.mindcollapse.com/blog/260.html">

        
            <link rel="next" href="https://www.mindcollapse.com/blog/259.html">
        

        
            <link rel="prev" href="https://www.mindcollapse.com/blog/261.html">
        

        <meta property="og:title" content="Продолжаем копать HTML5: Comet, WebSockets, EventSource, NodeJS">
        <meta property="og:description" content="Все помнят мой гневный (скорее, ироничный вентиляторно-лопаточный вброс, на который многие купились, смотри UPD внизу следующей ссылки) пост про HTML5 и про весь тот шум, который нагнетается вокруг сырой и неготовой к массовому использованию технологии. В ...">
        <meta property="og:type" content="article">
        <meta property="og:site_name" content="mindcollapse.com">
        <meta property="og:url" content="https://www.mindcollapse.com/blog/260.html">

        <meta name="description" content="Все помнят мой гневный (скорее, ироничный вентиляторно-лопаточный вброс, на который многие купились, смотри UPD внизу следующей ссылки) ...">

        <meta name="twitter:creator" content="@middlesizetit">
        <meta name="twitter:description" content="Все помнят мой гневный (скорее, ироничный вентиляторно-лопаточный вброс, на который многие купились, смотри UPD внизу следующей ссылки) пост про HTML5 и про весь тот шум, ...">
        <meta name="twitter:title" content="Продолжаем копать HTML5: Comet, WebSockets, EventSource, NodeJS">

        
            <meta name="twitter:card" content="summary">
        
    

    <link rel="publisher" href="https://plus.google.com/110904145311662435301">
    <link rel="icon" href="https://www.mindcollapse.com/favicon.ico" type="image/vnd.microsoft.icon">
    <link rel="alternate" type="application/atom+xml" title="RSS лента mindcollapse.com" href="https://www.mindcollapse.com/blog.xml"> 

    
        <link href="/static/compiled/blog.css?47e4fb13" rel="stylesheet" media="all">
    

    
        <script type="text/javascript" async src="/static/compiled/blog.js?c6c1320e"></script>
    

    <!--[if lt IE 9]>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.js"></script>
    <![endif]-->
</head>

<body class="mindcollapse">
    <main class="container">
        <header class="header navbar navbar-default hidden-print">
            <nav class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".blogmenu">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a href="/" class="navbar-brand">Владимир Смирнов</a>
            </nav>

            <nav class="collapse navbar-collapse blogmenu" role="navigation">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/">Блог</a></li>
                    <li ><a href="/blog/archive/">Архив</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a target="_blank" href="https://twitter.com/middlesizetit">Twitter</a></li>
                    <li><a target="_blank" href="https://github.com/mindcollapse">GitHub</a></li>
                    <li><a href="https://www.mindcollapse.com/blog.xml">RSS</a></li>
                </ul>
            </nav>
        </header>

        
    <article class="article hentry" itemscope itemtype="http://schema.org/Article" role="main">
        <div class="content_header clearfix">
            <div itemprop="name" class="entry-title pull-left">
                <h1><a itemprop="url" href="https://www.mindcollapse.com/blog/260.html">Продолжаем копать HTML5: Comet, WebSockets, EventSource, NodeJS</a></h1>
            </div>

            <div class="published pull-right">
                <time itemprop="datePublished" datetime="2011-07-18T00:00:00Z" class="text-muted updated">18 июля 2011 г.</time>
            </div>

            <div class="vcard author hidden">
                <a itemprop="author" class="url fn" href="http://www.mindcollapse.com/">Vladimir Smirnov</a>
            </div>
        </div>

        <hr class="first">

        <div itemprop="description" class="entry-content content">
            Все по­мнят мой гнев­ный (ско­рее, иро­нич­ный вен­ти­ля­тор­но-ло­па­точ­ный вброс, на ко­то­рый мно­гие ку­пи­лись, смот­ри UPD вни­зу сле­ду­ю­щей ссыл­ки) <a href="http://www.mindcollapse.com/blog/234.html" title="">пост про HTML5</a>&nbsp;и про весь тот шум, ко­то­рый на­гне­та­ет­ся во­круг сы­рой и не­го­то­вой к мас­со­во­му ис­поль­зо­ва­нию тех­но­ло­гии. В ка­кой-то ме­ре, дан­ный пост ста­нет оче­ред­ным то­му до­ка­за­тель­ством, но, в то же вре­мя, если этот&nbsp;эфе­мер­ный&nbsp;на­бор стан­дар­тов бу­дет ко­гда-то окон­чен, то мы, ве­браз­ра­бот­чи­ки, по­лу­чим от­лич­ный ин­стру­мен­та­рий, ко­то­рый ли­шит не­об­хо­ди­мо­сти со­би­рать ве­ло­си­пе­ды с квад­рат­ны­ми ко­ле­са­ми для ез­ды по&nbsp;стек­лян­ным&nbsp;рель­сам. Ну вы по­ня­ли.<p>Да­вай­те по по­ряд­ку. Сей­час в мо­де real-time ком­му­ни­ка­ции, в тех­ни­че­ском смыс­ле это­го сло­ва. Кон­такт, ли­цокни­га, гугло­плю­сы - все пе­ре­чис­лен­ные со­ци­аль­ные се­ти имею свой WebIM, поз­во­ля­ю­щий в ре­аль­ном вре­ме­ни об­щать­ся со сво­и­ми дру­зья­ми и по­дру­га­ми. Прав­да, кон­цеп­ция там не­мно­го дру­гая, ча­ты этих со­ци­а­лок, как пра­ви­ло, пред­став­ля­ют со­бой JavaScript оберт­ку во­круг XMPP про­то­ко­ла, но смысл по­ня­тен. Еще, спра­вед­ли­во­сти ра­ди, сто­ит за­ме­тить, что WebSockets и Server-Sent Events в на­сто­я­щее вре­мя вы­де­ле­ны из спе­ци­фи­ка­ции HTML5 в от­дель­ные до­ки, но, опять та­ки, я утвер­ждаю и бу­ду утвер­ждать, что HTML5 - не тех­но­ло­гия, а мар­ке­тин­го­вый бренд и пись­ко­ме­рял­ка со­вре­мен­ных бра­у­зе­ров, по­это­му отож­де­ствле­ние по­ня­тий тут до­пу­сти­мо. Пе­ре­до мной бы­ла по­став­ле­на за­да­ча со­здать при­ло­же­ние, поз­во­ля­ю­щее в ре­аль­ном вре­ме­ни об­ме­ни­вать­ся ин­фор­ма­ци­ей меж­ду сер­ве­ром и кли­ен­том с ми­ни­маль­ны­ми за­держ­ка­ми. Бла­го, при­ло­же­ние это ис­клю­чи­тель­но ин­тра­не­тов­ское и плат­фор­ма ис­поль­зо­ва­ние - Google Chrome, а зна­чит тех­ни­че­ски я не был огра­ни­чен. Ва­ри­ан­тов бы­ло не­сколь­ко: long-polling HTTP за­про­сы, HTTP Streaming или fast-polling, все это на­зы­ва­ет­ся Comet мо­де­лью. И у каж­дой ре­а­ли­за­ции есть свой не­до­ста­ток. В <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.1.4" title="">спе­ци­фи­ка­ции</a> HTTP/1.1 чет­ко ука­за­но, что бра­у­зер не дол­жен со­зда­вать од­но­вре­мен­но бо­лее 2х па­рал­лель­ных со­еди­не­ний к сер­ве­ру. Ко­неч­но, со­вре­мен­ные бра­у­зе­ры мо­гут под­дер­жи­вать де­ся­ток connections и по­доб­ное на­ру­ше­ние стан­дар­та не яв­ля­ет­ся фа­таль­ным, но в каж­дом из ва­ри­ан­тов ре­ше­ния есть свои не­до­стат­ки. Fast-polling, ко­то­рый пред­став­ля­ет со­бой мно­го­крат­ное по­вто­ре­ние за­про­са (с за­вер­ше­ни­ем сес­сии) со­зда­ет при­лич­ную на­груз­ку на сер­вер, а "ви­ся­щие" за­про­сы - ко­сты­ли, ко­то­рые при­во­дят ли­бо к memory-leak (в по­след­нем фа­ер­фок­се сде­лать garbage collector для бу­фе­ра за­про­са не удо­су­жи­лись, в хро­ме и са­фа­ри па­мять чи­стит­ся, но толь­ко для за­про­сов, воз­вра­ща­ю­щих "Transfer-Encoding: chunked"), к то­му же, кон­тро­ли­ро­вать Comet сес­сию слож­нее, она мо­жет от­ва­ли­вать­ся без ка­кой-ли­бо ви­ди­мой при­чи­ны, да и из­на­чаль­но про­то­кол со­зда­вал­ся не для это­го. Есть еще BOSH, ко­то­рый ис­поль­зу­ет­ся в вы­ше­упо­мя­ну­том XMPP, но он за­то­чен боль­ше под со­зда­ние ча­тов и го­то­вых ре­ше­ний для этой тех­но­ло­гии очень ма­ло. В PaaS&nbsp;<a href="http://www.mindcollapse.com/blog/255.html" title="">Google App Engine</a>, на ко­то­ром рас­по­ло­жен этот блог, есть Channel API, что-то вро­де Comet-а, я да­же пы­тал­ся по­про­бо­вать, но воз­мож­но­сти то­же све­де­ны до ми­ни­му­ма. Ко­неч­но мож­но еще ис­поль­зо­вать оберт­ки во­круг flash socket или java-ап­пле­та, но не это­му учи­ла нас пар­тия.</p><p>Вот имен­но та­ким пу­тем, пе­ре­про­бо­вав все вы­ше­на­зван­ные ме­то­ды и оце­нив ре­сур­со­ем­кость, я ре­шил оста­но­вить­ся на server-sent events и web-sockets, ко­то­рые вро­де да­же вы­ве­де­ны из ста­ту­са экс­пе­ре­мен­таль­ных в по­след­них вер­си­ях Webkit-а. На­чнем с SSE, спе­ци­фи­ка­цию мож­но по­чи­тать <a href="http://t.co/rWKHcsy" title="">тут</a>. По су­ти, это тот же HTTP Streaming на сте­ро­и­дах. Его смысл за­клю­ча­ет­ся в том, что в JavaScript ко­де или DOM со­зда­ет­ся объ­ект&nbsp;EventSource со скрип­том в src атри­бу­те или ме­то­де-кон­струк­то­ре. Этот скрипт, преж­де все­го, дол­жен в кон­тек­сте "ви­ся­ще­го" со­еди­не­ния (хо­тя и не обя­за­тель­но) воз­вра­щать кор­рект­ный Content-Type:&nbsp;text/event-stream и в даль­ней­шем push-ить об­нов­ле­ние кли­ен­ту в ви­де стро­ки data: any_text_info \n\n. То бишь, про­то­кол аб­со­лют­но од­но­сто­рон­ний, нас это впол­не устра­и­ва­ет, об­щать­ся обрат­но&nbsp;мы мо­жем и че­рез ми­лый серд­цу XHR. Есть в нем и вкус­но­сти, к при­ме­ру, от­вет event: test-remote-event \n data: success \n\n, если ве­рить стан­дар­ту, мож­но об­ра­ба­ты­вать в addEventListener('test-remote-event' ,function(data){}), прав­да, это по­ка толь­ко на бу­ма­ге. В Chrome Canary у ме­ня ра­бо­тал толь­ко event onmessage. Со сто­ро­ны все все­гда ка­жет­ся та­ким кра­си­вым, но тут на­ча­лись про­бле­мы, бы­ва­ет, что по­ток про­сто ви­сит. Ни­ка­кой onerror или onclose не вы­зы­вал­ся, сер­вер про­дол­жа­ет ис­прав­но по­сы­лать дан­ные, что про­ве­ря­ет­ся curl-ом в кон­со­ли, но бра­у­зе­ру по­фиг, хо­тя ре­старт стра­ни­цы по­мо­га­ет. Про­бо­вал в Chrome Stable - та же &nbsp;за­мо­роч­ка. ЧЯД­НТ? Вто­рая и бо­лее се­рьез­ная про­бле­ма - от­сут­ствие под­держ­ки&nbsp;<a href="http://en.wikipedia.org/wiki/Cross-Origin_Resource_Sharing" title="">CORS</a>,&nbsp;Access-Control-Allow-Origin: * от­сы­ла­ет­ся, но бра­у­зе­рам на не­го с боль­шой ко­ло­коль­ни, они воз­вра­ща­ют DOM Exception 18. Оче­ред­ная брешь в стан­дар­те, как так - XHR ра­бо­та­ет, а EventSource нет. Ко­неч­но, это все при­дир­ки, мож­но бы­ло бы за­вер­нуть тра­фик че­рез proxy_pass в nginx, но в лю­бом слу­чае, оса­док остал­ся. К то­му же, нуж­но уже бы­ло ду­мать о про­вер­ке на­ли­чия \n\n в кон­тен­те, ина­че бы­ла бы ве­ро­ят­ность по­лу­чить по­би­тый от­вет. Та­ким вот пу­тем я и при­шел к WebSockets. Рас­ска­зы­вать что-ли­бо про кли­ент­скую часть не име­ет смыс­ла, есть <a href="http://dev.w3.org/html5/websockets/" title="">спе­ци­фи­ка­ция</a>, все это де­ла­ет­ся од­ной стро­кой ко­да, да­вай­те луч­ше крат­ко по­го­во­рим, как ре­а­ли­зо­вать по­доб­ное на сер­ве­ре. В ка­че­стве server-side для по­доб­ных про­ек­тов я все­гда ре­ко­мен­дую брать NodeJS. Са­ма па­ра­диг­ма event based не­бло­ки­ру­ю­ще­го&nbsp;асин­хрон­но­го&nbsp;сер­ве­ра иде­аль­но под­хо­дит для вы­со­ко­за­гру­жен­ных API, а этот са­мый ин­тра­нет, он очень боль­шой и за­про­сы ре­сур­со­ем­кие. К то­му же, име­ю­ще­го­ся в&nbsp;<a href="http://npmjs.org/" title="">NPM</a>&nbsp;до­бра с го­ло­вой хва­тит для ре­ше­ния лю­бых за­дач.</p><p>Для де­мон­стра­ции воз­мож­но­стей, я на­пи­сал не­боль­шое при­ло­же­ние. Про­пи­са­но оно <a href="http://lab.mindcollapse.com/TwiNodeSSE/" title="">по ад­ре­су</a>. Ра­бо­тать долж­но в Chrome, Safari (в том чис­ле и на iPad, iPhone с 4.2) и FF. Но в по­след­нем нуж­но вклю­чить под­держ­ку со­ке­тов. Вот вам <a href="http://j.mp/ncKqmD" title="">ма­ну­ал</a>. Дол­го ду­мал, от­ку­да бы взять боль­шой по­ток дан­ных для на­гляд­но­го при­ме­ра, как вспо­мнил про Twitter Streaming API. Код го­то­во­го при­ло­же­ния мож­но не­воз­бран­но&nbsp;<a href="http://commondatastorage.googleapis.com/files.mindcollapse.com/etc/TwiNodeSSE.zip" title="">ска­чать ар­хи­вом</a>. Если де­мон­стра­ция пе­ре­ста­нет ра­бо­тать - про­шу ме­ня про­стить, мой ста­рень­кий сер­вер очень неж­ный и не­то­ро­пли­вый, и боль­ше вре­ме­ни за­ня­ла ком­пи­ля­ция node, чем про­чте­ние до­ку­мен­та­ции или на­пи­са­ние са­мо­го ко­да. Ра­зу­ме­ет­ся, в server.js нуж­но впи­сать свои ло­гин и па­роль. Во­об­ще, я ис­поль­зую sample по­ток, а вы, про­чи­тав до­ку­мен­та­цию по твит­тер апи и <a href="https://github.com/technoweenie/twitter-node" title="">twitter-node</a>, мо­же­те со­здать ка­кой-то по­лез­ный сер­вис мо­ни­то­рин­га и ана­ли­ти­ки хе­ште­гов, или вы­во­дить в фор­ме гра­ниц Укра­и­ны ава­та­ры поль­зо­ва­те­лей, на­пи­сав­ших что-то на мо­ве. Фан­та­зии огра­ни­че­ны ис­клю­чи­тель­но воз­мож­но­стя­ми API твит­те­ра, а их бо­лее чем хва­та­ет.</p><p>В за­клю­че­ние,&nbsp;хо­чу ска­зать, что я по­сте­пен­но пе­ре­смат­ри­ваю фор­мат бло­га, если вам по­нра­ви­лась по­доб­ная ста­тья - не по­ле­ни­тесь пе­рей­ти на веб вер­сию, если в РСС чи­та­е­те, и вос­поль­зо­вать­ся кноп­кой Google +1. Если со­бе­рет­ся не­мно­го плю­сов, то в бли­жай­шее вре­мя мы по­го­во­рим про WebWorkers, Forms Validation, на­ри­су­ем муж­ской по­ло­вой хуй в Canvas, на­пи­шем вра­ща­ю­щий­ся чай­ник на WebGL и по­про­бу­ем на­кла­ды­вать филь­тры и по­лу­чать ин­фор­ма­цию из те­га &lt;video&gt;.</p>
        </div>
    </article>

    <hr>

    <footer class="footer hidden-print">
        <p>Что делать, если вы все прочитали и вам понравилось? Можете посмотреть мои остальные статьи в <a href="/blog/archive/">архиве</a> или поделиться ссылкой в <span class="social"><a target="_blank" href="http://www.facebook.com/sharer.php?u=https%3A//www.mindcollapse.com/blog/260.html">фейсбуке</a>, <a target="_blank" href="http://twitter.com/share?url=https%3A//www.mindcollapse.com/blog/260.html&amp;text=%D0%9F%D1%80%D0%BE%D0%B4%D0%BE%D0%BB%D0%B6%D0%B0%D0%B5%D0%BC%20%D0%BA%D0%BE%D0%BF%D0%B0%D1%82%D1%8C%20HTML5%3A%20Comet%2C%20WebSockets%2C%20EventSource%2C%20NodeJS&amp;via=middlesizetit">твиттере</a> или <a target="_blank" href="http://vkontakte.ru/share.php?url=https%3A//www.mindcollapse.com/blog/260.html">в контакте</a></span>.</p>
    </footer>

    </main>
</body>

</html>
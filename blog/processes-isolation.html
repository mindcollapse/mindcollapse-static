<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">

    <title>Теория изоляции и лимитирования процессов в linux userspace</title> 

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="jm8IGIWg4dsm0cTmih0sIVnUaWibc_hpOiQOlqb--9Y"> 
    <meta name="yandex-verification" content="4b85f46617ab1114"> 
    <meta name="y_key" content="04bed234d6a405cc"> 
    <meta name="msvalidate.01" content="62188F55275960794DDFA698C3EA9F05">

    <link rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.ru">
    <link rel="sitemap" href="http://www.mindcollapse.com/blog/sitemap.xml">

    
        <link rel="canonical" href="http://www.mindcollapse.com/blog/processes-isolation.html">

        <link rel="up archives" href="http://www.mindcollapse.com/blog/archive/">

        
            <link rel="next" href="http://www.mindcollapse.com/blog/hong-kong.html">
        

        
            <link rel="prev" href="http://www.mindcollapse.com/blog/despair.html">
        

        <meta property="og:title" content="Теория изоляции и лимитирования процессов в linux userspace">
        <meta property="og:description" content="Этот пост за­ду­мы­вал­ся по­яс­ни­тель­ны­ми ком­мен­та­ри­я­ми к лис­тин­гу го­то­вой про­грам­мы, но ме­ня по­че­му-то в са­мый по­след­ний мо­мент по­про­си­ли уда­лить ре­по­зи­та­рий из гит­ха­ба, хо­тя от­кры­тость ко­да бы­ла ого­во­ре­на за­ра­нее. Вот так те­о­рия и прак­ти­ка в ...">
        <meta property="og:type" content="article">
        <meta property="og:site_name" content="mindcollapse.com">
        <meta property="og:url" content="http://www.mindcollapse.com/blog/processes-isolation.html">

        <meta name="description" content="Этот пост за­ду­мы­вал­ся по­яс­ни­тель­ны­ми ком­мен­та­ри­я­ми к лис­тин­гу го­то­вой про­грам­мы, но ме­ня по­че­му-то в са­мый по­след­ний мо­мент ...">

        <meta name="twitter:card" content="summary">
        <meta name="twitter:creator" content="@middlesizetit">
        <meta name="twitter:description" content="Этот пост за­ду­мы­вал­ся по­яс­ни­тель­ны­ми ком­мен­та­ри­я­ми к лис­тин­гу го­то­вой про­грам­мы, но ме­ня по­че­му-то в са­мый по­след­ний мо­мент по­про­си­ли уда­лить ре­по­зи­та­рий из ...">
        <meta name="twitter:title" content="Теория изоляции и лимитирования процессов в linux userspace">
    

    <link rel="author" href="https://plus.google.com/110904145311662435301">
    <link rel="icon" href="http://www.mindcollapse.com/favicon.ico" type="image/vnd.microsoft.icon">
    <link rel="alternate" type="application/atom+xml" title="RSS лента mindcollapse.com" href="http://www.mindcollapse.com/blog.xml"> 

    
        <link href="/static/compiled/blog.css?f55bb245" rel="stylesheet" media="all">
    

    
        <script type="text/javascript" src="/static/compiled/blog.js?f97a9d7b" defer></script>
    

    <!--[if lt IE 9]>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.js"></script>
    <![endif]-->
</head>

<body class="mindcollapse">
    <div class="container">

        <div class="header navbar navbar-default hidden-print" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".blogmenu">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a href="/" class="navbar-brand">Владимир Смирнов</a>
            </div>

            <div class="collapse navbar-collapse blogmenu">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/">Блог</a></li>
                    <li ><a href="/blog/archive/">Архив</a></li>
                    <li><a target="_blank" href="/moho/">Кино</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a target="_blank" href="http://www.twitter.com/middlesizetit">Twitter</a></li>
                    <li><a target="_blank" href="https://github.com/mindcollapse">GitHub</a></li>
                    <li><a href="http://www.mindcollapse.com/blog.xml">RSS</a></li>
                </ul>
            </div>
        </div>

        
	<div class="article hentry" id="post_" itemscope itemtype="http://schema.org/BlogPosting" role="main">
		<div class="content_header clearfix">
			<h1 itemprop="name" class="entry-title pull-left"><a itemprop="url" href="http://www.mindcollapse.com/blog/processes-isolation.html">Теория изоляции и лимитирования процессов в linux userspace</a></h1>
			<div class="published pull-right"><time itemprop="datePublished" datetime="2012-11-05T00:00:00Z" class="text-muted updated">5 ноября 2012 г.</time></div>
		</div>

		<hr class="first">

		<div itemprop="articleBody" class="entry-content content">
			<p><img alt="Теория изоляции и лимитирования процессов в linux userspace" src="/static/media/blog/processes-isolation/header.jpg" /></p>
<p>Этот пост за&shy;ду&shy;мы&shy;вал&shy;ся по&shy;яс&shy;ни&shy;тель&shy;ны&shy;ми ком&shy;мен&shy;та&shy;ри&shy;я&shy;ми к лис&shy;тин&shy;гу го&shy;то&shy;вой про&shy;грам&shy;мы, но ме&shy;ня по&shy;че&shy;му-то в са&shy;мый по&shy;след&shy;ний мо&shy;мент по&shy;про&shy;си&shy;ли уда&shy;лить ре&shy;по&shy;зи&shy;та&shy;рий из гит&shy;ха&shy;ба, хо&shy;тя от&shy;кры&shy;тость ко&shy;да бы&shy;ла ого&shy;во&shy;ре&shy;на за&shy;ра&shy;нее. Вот так те&shy;о&shy;рия и прак&shy;ти&shy;ка в за&shy;го&shy;лов&shy;ке ста&shy;тьи пре&shy;вра&shy;ти&shy;лась про&shy;сто в те&shy;о&shy;рию. Впро&shy;чем, я по&shy;ста&shy;ра&shy;юсь до&shy;ста&shy;точ&shy;но де&shy;таль&shy;но рас&shy;ска&shy;зать о двух основ&shy;ных спо&shy;со&shy;бах изо&shy;ля&shy;ции и ли&shy;ми&shy;ти&shy;ро&shy;ва&shy;ния ис&shy;пол&shy;ня&shy;е&shy;мо&shy;го про&shy;цес&shy;са: basic, ко&shy;то&shy;рый не тре&shy;бу&shy;ет осо&shy;бых зна&shy;ний, пе&shy;ре&shy;сбор&shy;ки ядра, а не&shy;об&shy;хо&shy;ди&shy;мый функ&shy;ци&shy;о&shy;нал уже при&shy;сут&shy;ству&shy;ет во всех со&shy;вре&shy;мен&shy;ных дис&shy;три&shy;бу&shy;ти&shy;вах и advanced. </p>
<p>Пе&shy;ре&shy;до мной бы&shy;ла по&shy;став&shy;ле&shy;на сле&shy;ду&shy;ю&shy;щая за&shy;да&shy;ча - на&shy;пи&shy;сать бы&shy;струю и по&shy;стро&shy;ен&shy;ную не на ин&shy;стру&shy;мен&shy;тах ап&shy;па&shy;рат&shy;ной или про&shy;грамм&shy;ной вир&shy;ту&shy;а&shy;ли&shy;за&shy;ции сре&shy;ду за&shy;пус&shy;ка по&shy;тен&shy;ци&shy;аль&shy;но не&shy;без&shy;опас&shy;но&shy;го поль&shy;зо&shy;ва&shy;тель&shy;ско&shy;го ко&shy;да. Что&shy;бы вам ста&shy;ло по&shy;нят&shy;ней, мо&shy;же&shy;те взгля&shy;нуть на <a href="http://codepad.org/">Codepad</a> или <a href="http://ideone.com/">Ideone</a> - са&shy;мые обыч&shy;ные па&shy;сте&shy;би&shy;ны, поз&shy;во&shy;ля&shy;ю&shy;щие со&shy;би&shy;рать и вы&shy;пол&shy;нять на&shy;пи&shy;сан&shy;ный не&shy;из&shy;вест&shy;ным Ва&shy;си&shy;ли&shy;ем код, воз&shy;вра&shy;щая стан&shy;дарт&shy;ный вы&shy;вод про&shy;цес&shy;са. По&shy;доб&shy;ные за&shy;да&shy;чи - не мое про&shy;филь&shy;ное на&shy;прав&shy;ле&shy;ние, по&shy;это&shy;му про&shy;шу ме&shy;ня про&shy;стить, если я вдруг кое-где оши&shy;бусь в те&shy;о&shy;рии или бу&shy;ду го&shy;во&shy;рить от&shy;кро&shy;вен&shy;ные глу&shy;по&shy;сти.</p>
<p>Преж&shy;де все&shy;го, су&shy;ще&shy;ству&shy;ю&shy;щие ре&shy;ше&shy;ния ко&shy;неч&shy;но же есть. Я не бу&shy;ду сей&shy;час пе&shy;ре&shy;чис&shy;лять все на&shy;ко&shy;лен&shy;ные по&shy;дел&shy;ки в этой об&shy;ла&shy;сти, боль&shy;шин&shy;ство из них на&shy;пи&shy;са&shy;ны для сво&shy;ей кон&shy;крет&shy;ной за&shy;да&shy;чи и нам не под&shy;хо&shy;дят. Без&shy;услов&shy;но, ра&shy;бо&shy;та&shy;ю&shy;щую си&shy;сте&shy;му мож&shy;но по&shy;стро&shy;ить на осно&shy;ве SELinux или AppArmor, оба про&shy;ек&shy;та име&shy;ют ба&shy;зо&shy;вую под&shy;держ&shy;ку сэнд&shy;бок&shy;син&shy;га, пусть и на&shy;хо&shy;дя&shy;щу&shy;ю&shy;ся в со&shy;сто&shy;я&shy;нии "в ран&shy;ней раз&shy;ра&shy;бот&shy;ке" уже очень дол&shy;го вре&shy;мя. Оста&shy;нав&shy;ли&shy;вать&shy;ся на этой те&shy;ма&shy;ти&shy;ке мы не бу&shy;дем, нас ин&shy;те&shy;ре&shy;су&shy;ет свое соб&shy;ствен&shy;ное ре&shy;ше&shy;ние, ин&shy;фор&shy;ма&shy;цию о пе&shy;соч&shy;ни&shy;це в SELinux мож&shy;но по&shy;чи&shy;тать в <a href="http://danwalsh.livejournal.com/28545.html">ЖЖ</a> раз&shy;ра&shy;бот&shy;чи&shy;ка. Про AppArmor <a href="http://wiki.apparmor.net/index.php/AppArmorSandboxing">aa-sandbox</a> то&shy;же ни&shy;че&shy;го ска&shy;зать не мо&shy;гу, раз&shy;ве что син&shy;так&shy;сис кон&shy;фи&shy;гу&shy;ра&shy;ци&shy;он&shy;ных фай&shy;лов по&shy;нят&shy;ней крас&shy;но&shy;гла&shy;зо&shy;го се&shy;ли&shy;нук&shy;са.</p>
<p>Пи&shy;сать мы бу&shy;дем на си&shy;шеч&shy;ке. По&shy;че&shy;му, я ду&shy;маю, объ&shy;яс&shy;нять не нуж&shy;но. По&shy;чти все, что мы бу&shy;дем ис&shy;поль&shy;зо&shy;вать, уже есть в ядре и libc. Основ&shy;ной ал&shy;го&shy;ритм ра&shy;бо&shy;ты со&shy;сто&shy;ит в сле&shy;ду&shy;ю&shy;щем: мы за&shy;пус&shy;ка&shy;ем свой сэнд&shy;бокс, ко&shy;то&shy;рый фор&shy;ка&shy;ет не&shy;без&shy;опас&shy;ный про&shy;цесс, за&shy;го&shy;ня&shy;ет его в пе&shy;соч&shy;ни&shy;цу и вы&shy;пол&shy;ня&shy;ет, воз&shy;вра&shy;щая stdout. Де&shy;ла&shy;ет&shy;ся это эле&shy;мен&shy;тар&shy;но с по&shy;мо&shy;щью <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/clone.2.html">clone()</a> или <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/fork.2.html">fork()</a> с даль&shy;ней&shy;шим за&shy;пус&shy;ком че&shy;рез <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/execve.2.html">execve()</a>. Для нас пред&shy;по&shy;чти&shy;тель&shy;ным спо&shy;со&shy;бом яв&shy;ля&shy;ет&shy;ся ис&shy;поль&shy;зо&shy;ва&shy;ние clone(), ко&shy;то&shy;рый поз&shy;во&shy;ля&shy;ет де&shy;таль&shy;но ука&shy;зать кон&shy;текст ро&shy;ди&shy;те&shy;ля, ко&shy;то&shy;рым мы бу&shy;дем де&shy;лить&shy;ся с до&shy;чер&shy;ним про&shy;цес&shy;сом. По&shy;дроб&shy;нее о раз&shy;ли&shy;чи&shy;ях этих двух си&shy;стем&shy;ных вы&shy;зо&shy;вов мож&shy;но по&shy;чи&shy;тать <a href="http://stackoverflow.com/questions/4856255/the-difference-between-fork-vfork-exec-and-clone">тут</a>, на&shy;при&shy;мер. По&shy;доб&shy;но&shy;го эф&shy;фек&shy;та мож&shy;но до&shy;бить&shy;ся и с fork-ом, если вам так удоб&shy;ней, ис&shy;поль&shy;зуя <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/unshare.2.html">unshare()</a>. В част&shy;но&shy;сти, для изо&shy;ля&shy;ции про&shy;цес&shy;са нам не&shy;об&shy;хо&shy;ди&shy;мы сле&shy;ду&shy;ю&shy;щие <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/clone.2.html">бит&shy;мас&shy;ки</a> CLONE_NEWIPC, CLONE_NEWNET (са&shy;мый про&shy;стой спо&shy;соб от&shy;ре&shy;зать ис&shy;пол&shy;ня&shy;е&shy;мый про&shy;цесс от се&shy;ти, мож&shy;но еще вос&shy;поль&shy;зо&shy;вать&shy;ся iptables c ipt_owner), CLONE_NEWNS (это нам по&shy;на&shy;до&shy;бит&shy;ся чуть ни&shy;же, ко&shy;гда мы дой&shy;дем до cgroups), CLONE_NEWPID, SIGCHLD (ина&shy;че <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/wait.2.html">wait()</a> не бу&shy;дет по&shy;лу&shy;чать сиг&shy;на&shy;лы от до&shy;чер&shy;не&shy;го про&shy;цес&shy;са). Что&shy;бы бы&shy;ло бо&shy;лее ме&shy;нее по&shy;нят&shy;но, я на&shy;бро&shy;сал не&shy;боль&shy;шой <a href="https://gist.github.com/4016027">ша&shy;блон</a>. Код про&shy;стой, но мы до&shy;би&shy;лись же&shy;ла&shy;е&shy;мо&shy;го. Преж&shy;де все&shy;го мы за&shy;гна&shy;ли про&shy;цесс в от&shy;дель&shy;ные <a href="http://lwn.net/Articles/219794/">Network</a>, <a href="http://www.ibm.com/developerworks/linux/library/l-mount-namespaces/index.html">Mount</a>, <a href="http://menehune.opt.wfu.edu/Kokua/More_SGI/007-2478-008/sgi_html/ch02.html">IPC</a> и <a href="http://lwn.net/Articles/259217/">PID</a> нейм&shy;спей&shy;сы и при&shy;ми&shy;тив&shy;но огра&shy;ни&shy;чи&shy;ли мак&shy;си&shy;маль&shy;ное ре&shy;аль&shy;ное вре&shy;мя ис&shy;пол&shy;не&shy;ния с по&shy;мо&shy;щью <a href="http://linux.die.net/man/2/alarm">alarm()</a> и со&shy;от&shy;вет&shy;ству&shy;ю&shy;ще&shy;го об&shy;ра&shy;бот&shy;чи&shy;ка SIGALRM, уби&shy;ва&shy;ю&shy;ще&shy;го до&shy;чер&shy;ний про&shy;цесс. Об&shy;ра&shy;щаю ва&shy;ше вни&shy;ма&shy;ние, что CLONE_NEWPID, ко&shy;то&shy;рый ли&shy;ша&shy;ет на&shy;шу пе&shy;соч&shy;ни&shy;цу воз&shy;мож&shy;но&shy;сти по&shy;сы&shy;лать <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/kill.2.html">kill()</a> или <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/ptrace.2.html">ptrace()</a> про&shy;цес&shy;сам вне изо&shy;ли&shy;ро&shy;ван&shy;но&shy;го окру&shy;же&shy;ния, до&shy;сту&shy;пен в ядре на&shy;чи&shy;ная с 2.6.24, ко&shy;то&shy;рое долж&shy;но быть со&shy;бра&shy;но с оп&shy;ци&shy;ей CONFIG_PID_NS. Вы мо&shy;же&shy;те ис&shy;поль&shy;зо&shy;вать <a href="http://code.google.com/p/chromium/wiki/LinuxPidNamespaceSupport">сле&shy;ду&shy;ю&shy;щий код</a> для про&shy;вер&shy;ки его до&shy;ступ&shy;но&shy;сти, ли&shy;бо же cat /boot/config-<code>uname -r</code> | grep CONFIG_PID_NS.</p>
<p>Огра&shy;ни&shy;чив ба&shy;зо&shy;вый до&shy;ступ, мож&shy;но на&shy;чи&shy;нать огра&shy;ни&shy;чи&shy;вать вы&shy;де&shy;ля&shy;е&shy;мые ре&shy;сур&shy;сы. Де&shy;ла&shy;ет&shy;ся это с по&shy;мо&shy;щью вы&shy;зо&shy;ва <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/getrlimit.2.html">setrlimit()</a>. В на&shy;шем слу&shy;чае нас бу&shy;дут ин&shy;те&shy;ре&shy;со&shy;вать зна&shy;че&shy;ния RLIMIT_AS (ли&shy;мит раз&shy;ме&shy;ра ад&shy;рес&shy;но&shy;го про&shy;стран&shy;ства про&shy;цес&shy;са в бай&shy;тах), RLIMIT_CPU (ли&shy;мит <a href="http://www.gnu.org/software/libc/manual/html_node/Processor-And-CPU-Time.html#Processor-And-CPU-Time">CPU time</a> в се&shy;кун&shy;дах), RLIMIT_FSIZE (мак&shy;си&shy;маль&shy;ный раз&shy;мер со&shy;зда&shy;ва&shy;е&shy;мо&shy;го про&shy;цес&shy;сом фай&shy;ла в бай&shy;тах, за&shy;щи&shy;та от ду&shy;ра&shy;ка, лю&shy;бя&shy;ще&shy;го что-то вро&shy;де dd if=/dev/zero of=becausefuckyouthatswhy bs=1g count=10000), RLIMIT_NICE (мак&shy;си&shy;маль&shy;ное зна&shy;че&shy;ние для <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/nice.2.html">nice()</a> и <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/setpriority.2.html">setpriority()</a>, од&shy;но&shy;го nice() пе&shy;ред exec() бу&shy;дет не&shy;до&shy;ста&shy;точ&shy;но, без это&shy;го ли&shy;ми&shy;та про&shy;цесс все&shy;гда мо&shy;жет под&shy;нять зна&shy;че&shy;ние), RLIMIT_NOFILE (мак&shy;си&shy;маль&shy;ное ко&shy;ли&shy;че&shy;ство фай&shy;ло&shy;вых де&shy;скрип&shy;то&shy;ров, ко&shy;то&shy;рое мо&shy;жет от&shy;крыть про&shy;цесс), RLIMIT_NPROC (един&shy;ствен&shy;ный ли&shy;мит, ко&shy;то&shy;рый дол&shy;жен уста&shy;нав&shy;ли&shy;вать&shy;ся не&shy;по&shy;сред&shy;ствен&shy;но по&shy;сле <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/setuid.2.html">setuid()</a>, огра&shy;ни&shy;чи&shy;ва&shy;ет мак&shy;си&shy;маль&shy;ное ко&shy;ли&shy;че&shy;ство про&shy;цес&shy;сов, со&shy;зда&shy;ва&shy;е&shy;мых для UID вы&shy;зы&shy;ва&shy;ю&shy;ще&shy;го про&shy;цес&shy;са).</p>
<p>К бо&shy;лее гиб&shy;ко&shy;му ли&shy;ми&shy;ти&shy;ро&shy;ва&shy;нию мы еще вер&shy;нем&shy;ся, ко&shy;гда бу&shy;дем го&shy;во&shy;рить о cgroups. Наш про&shy;цесс уже изо&shy;ли&shy;ро&shy;ван от пря&shy;мо&shy;го вме&shy;ша&shy;тель&shy;ства в си&shy;сте&shy;му, оста&shy;лось лишь огра&shy;ни&shy;чить до&shy;ступ к фай&shy;ло&shy;вой си&shy;сте&shy;ме. Де&shy;лать мы это бу&shy;дем с по&shy;мо&shy;щью ста&shy;ро&shy;го до&shy;бро&shy;го <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/chroot.2.html">chroot()</a>. За го&shy;ды ра&shy;бо&shy;ты с сер&shy;ве&shy;ра&shy;ми я вы&shy;ра&shy;бо&shy;тал пра&shy;ви&shy;ло за&shy;пус&shy;ка со&shy;мни&shy;тель&shy;ных и по&shy;тен&shy;ци&shy;аль&shy;но не&shy;без&shy;опас&shy;ных при&shy;ло&shy;же&shy;ний вро&shy;де PHP и про&shy;че&shy;го гов&shy;на ис&shy;клю&shy;чи&shy;тель&shy;но в от&shy;дель&shy;ном root environment, со&shy;здан&shy;ном с по&shy;мо&shy;щью <a href="http://wiki.debian.org/Debootstrap">debootstrap</a> ли&shy;бо лю&shy;бо&shy;го па&shy;ке&shy;та в за&shy;ви&shy;си&shy;мо&shy;сти от це&shy;ле&shy;вой ОС. В по&shy;след&shy;нее вре&shy;мя, все ча&shy;ще поль&shy;зу&shy;юсь бо&shy;лее на&shy;деж&shy;ным и без&shy;опас&shy;ным <a href="http://lxc.sourceforge.net/">LXC</a> но раз&shy;го&shy;вор о дру&shy;гом. По&shy;сле вы&shy;зо&shy;ва chroot() дол&shy;жен обя&shy;за&shy;тель&shy;но сле&shy;до&shy;вать вы&shy;зов setuid() что&shy;бы не до&shy;пу&shy;стить воз&shy;мож&shy;но&shy;сти <a href="http://www.bpfh.net/simes/computing/chroot-break.html">по&shy;бе&shy;га</a> из тюрь&shy;мы. В на&shy;шем слу&shy;чае бу&shy;дет иде&shy;аль&shy;ным ис&shy;поль&shy;зо&shy;ва&shy;ние не&shy;су&shy;ще&shy;ству&shy;ю&shy;ще&shy;го ран&shy;дом&shy;но&shy;го UID-а на&shy;по&shy;до&shy;бие int new_uid = MAX_EXISTING_UID + random_in_range (1, 99). Вот и все, пра&shy;виль&shy;но вы&shy;став&shy;лен&shy;ный chmod() на ра&shy;бо&shy;чую ди&shy;рек&shy;то&shy;рию про&shy;цес&shy;са в со&shy;че&shy;та&shy;нии со всем вы&shy;ше&shy;на&shy;пи&shy;сан&shy;ным га&shy;ран&shy;ти&shy;ру&shy;ет до&shy;ста&shy;точ&shy;ную изо&shy;ля&shy;цию га&shy;де&shy;ны&shy;ша в пе&shy;соч&shy;ни&shy;це. Я по&shy;вто&shy;рюсь - до&shy;ста&shy;точ&shy;ную, но не иде&shy;аль&shy;ную, дан&shy;ный спо&shy;соб не спа&shy;са&shy;ет от privilege escalation атак или про&shy;чих уяз&shy;ви&shy;мо&shy;стей ядра, свя&shy;зан&shy;ных с memory allocation and management, на&shy;при&shy;мер. </p>
<p>Го&shy;во&shy;ря об advanced ме&shy;то&shy;дах ли&shy;ми&shy;ти&shy;ро&shy;ва&shy;ния и изо&shy;ля&shy;ции, мы рас&shy;смот&shy;рим при&shy;ме&shy;ры ис&shy;поль&shy;зо&shy;ва&shy;ния cgroups, ptrace, seccomp и seccomp-filters. </p>
<p>Cgroups или Control Groups - ме&shy;ха&shy;низм объ&shy;еди&shy;не&shy;ния про&shy;цес&shy;сов в груп&shy;пы с опре&shy;де&shy;лен&shy;ным по&shy;ве&shy;де&shy;ни&shy;ем и ли&shy;ми&shy;та&shy;ми. Дан&shy;ный функ&shy;ци&shy;о&shy;нал был на&shy;пи&shy;сан ин&shy;же&shy;не&shy;ра&shy;ми Google, вклю&shy;чен в мей&shy;н&shy;лайн ядра на&shy;чи&shy;ная с вер&shy;сии 2.6.24 и име&shy;ет до&shy;ста&shy;точ&shy;но хо&shy;ро&shy;шую <a href="http://www.kernel.org/doc/Documentation/cgroups/">до&shy;ку&shy;мен&shy;та&shy;цию</a>. А еще я на&shy;шел очень по&shy;нят&shy;ный <a href="http://programmersnook.blogspot.com/2011/04/cgroups.html">пост</a> на рус&shy;ском язы&shy;ке по этой те&shy;ма&shy;ти&shy;ке и раз&shy;же&shy;ван&shy;ное опи&shy;са&shy;ние в <a href="http://doc.opensuse.org/documentation/html/openSUSE/opensuse-tuning/cha.tuning.cgroups.html">до&shy;ку&shy;мен&shy;та&shy;ции</a> openSUSE. Как все&shy;гда, про&shy;ве&shy;ря&shy;ем не&shy;об&shy;хо&shy;ди&shy;мые нам оп&shy;ции с по&shy;мо&shy;щью zcat /proc/config.gz или cat /boot/config-<code>uname -r</code> | grep CGROUP. Cgroups име&shy;ют свое API, но мы бу&shy;дем ис&shy;поль&shy;зо&shy;вать бо&shy;лее про&shy;стой спо&shy;соб, осно&shy;ван&shy;ный на cgroup sysfs. Преж&shy;де все&shy;го, нуж&shy;но разо&shy;брать&shy;ся в иерар&shy;хии это&shy;го мо&shy;ду&shy;ля. Ко&shy;рень для cgroups (обыч&shy;но /sys/fs/cgroup/, но тут ни&shy;ка&shy;ко&shy;го пра&shy;ви&shy;ла нет) - обыч&shy;ная ди&shy;рек&shy;то&shy;рия, мо&shy;же&shy;те под&shy;мон&shy;ти&shy;ро&shy;вать ее как tmpfs. В кор&shy;не&shy;вую ди&shy;рек&shy;то&shy;рию мон&shy;ти&shy;ру&shy;ют&shy;ся под&shy;си&shy;сте&shy;мы cpuacct, cpuset, devices, freezer, memory и про&shy;чие. Весь спи&shy;сок мож&shy;но по&shy;смот&shy;реть в до&shy;ку&shy;мен&shy;та&shy;ции. При&shy;мон&shy;ти&shy;ро&shy;ван&shy;ная под&shy;си&shy;сте&shy;ма име&shy;ет вли&shy;я&shy;ние на все про&shy;цес&shy;сы дан&shy;но&shy;го UID, спи&shy;сок PID-ов мож&shy;но по&shy;смот&shy;реть в /sys/fs/cgroup/devices/tasks, как при&shy;мер. Из&shy;ме&shy;ня&shy;е&shy;мые па&shy;ра&shy;мет&shy;ры под&shy;си&shy;сте&shy;мы - фай&shy;лы, до&shy;ступ&shy;ные как для чте&shy;ния, так и на за&shy;пись. От&shy;дель&shy;ные груп&shy;пы - про&shy;стые пап&shy;ки в ди&shy;рек&shy;то&shy;рии под&shy;си&shy;сте&shy;мы. </p>
<p>На&shy;вер&shy;ное, я объ&shy;яс&shy;няю слиш&shy;ком то&shy;пор&shy;но. Что&shy;бы бы&shy;ло по&shy;нят&shy;ней, я на&shy;пи&shy;сал не&shy;боль&shy;шой <a href="https://gist.github.com/4016674">bash скрипт</a> по&shy;ка&shy;зы&shy;ва&shy;ю&shy;щий осно&shy;вы ра&shy;бо&shy;ты. Если по&shy;доб&shy;ный спо&shy;соб вза&shy;и&shy;мо&shy;дей&shy;ствия вам ка&shy;жет&shy;ся не до&shy;ста&shy;точ&shy;но низ&shy;ко&shy;уров&shy;не&shy;вым, мо&shy;же&shy;те обра&shy;тить вни&shy;ма&shy;ние на <a href="http://libcg.sourceforge.net/">libcg</a> - аб&shy;страк&shy;ции во&shy;круг control groups API, прав&shy;да до&shy;ку&shy;мен&shy;та&shy;ция там мяг&shy;ко го&shy;во&shy;ря гов&shy;ни&shy;стая, а нор&shy;маль&shy;но&shy;го при&shy;ме&shy;ра ис&shy;поль&shy;зо&shy;ва&shy;ния так и не уда&shy;лось най&shy;ти. Кста&shy;ти, Linux Containers осно&shy;ва&shy;ны имен&shy;но на ба&shy;зе cgroups.</p>
<p>Ка&shy;за&shy;лось бы, че&shy;го еще бо&shy;ять&shy;ся и пы&shy;тать&shy;ся изо&shy;ли&shy;ро&shy;вать. Тут нуж&shy;но вспо&shy;мнить те&shy;о&shy;рию ор&shy;га&shy;ни&shy;за&shy;ции и функ&shy;ци&shy;о&shy;ни&shy;ро&shy;ва&shy;ния со&shy;вре&shy;мен&shy;ных опе&shy;ра&shy;ци&shy;он&shy;ных си&shy;стем, ис&shy;поль&shy;зу&shy;ю&shy;щих system calls для вза&shy;и&shy;мо&shy;дей&shy;ствия с ядром ОС. Это если со&shy;всем гру&shy;бо, чуть де&shy;таль&shy;нее с во&shy;про&shy;сом мож&shy;но озна&shy;ко&shy;мить&shy;ся в на удив&shy;ле&shy;ние не&shy;пло&shy;хой <a href="http://en.wikipedia.org/wiki/System_call">ста&shy;тье в ви&shy;ки&shy;пе&shy;дии</a>. К при&shy;ме&shy;ру, мы зна&shy;ем, что /bin/cat ис&shy;поль&shy;зу&shy;ет&shy;ся сле&shy;ду&shy;ю&shy;щие syscall-ы для вы&shy;во&shy;да со&shy;дер&shy;жи&shy;мо&shy;го фай&shy;ла: mmap для вы&shy;де&shy;ле&shy;ния па&shy;мя&shy;ти, fstat для про&shy;вер&shy;ки су&shy;ще&shy;ство&shy;ва&shy;ния фай&shy;ла и прав до&shy;сту&shy;па к не&shy;му, open для от&shy;кры&shy;тия фай&shy;ло&shy;во&shy;го де&shy;скрип&shy;то&shy;ра, read для чте&shy;ния, write для вы&shy;во&shy;да со&shy;дер&shy;жи&shy;мо&shy;го тек&shy;ста в stdout и close для за&shy;кры&shy;тия всех от&shy;кры&shy;тых ра&shy;нее де&shy;скрип&shy;то&shy;ров. И мы уве&shy;ре&shy;ны, что /bin/cat уж точ&shy;но не дол&shy;жен вы&shy;зы&shy;вать execv(), bind() или там при cat test.txt пы&shy;тать&shy;ся от&shy;крыть /etc/shadow. Бо&shy;роть&shy;ся с этим мож&shy;но мед&shy;лен&shy;ным, но про&shy;ве&shy;рен&shy;ным ptrace(); бы&shy;стрым, но слож&shy;ным seccomp; ли&shy;бо же оп&shy;ти&shy;маль&shy;ным, но при&shy;сут&shy;ству&shy;ю&shy;щим толь&shy;ко в по&shy;след&shy;них вер&shy;си&shy;ях ядра, seccomp-filters.</p>
<p>Как уже бы&shy;ло ска&shy;за&shy;но вы&shy;ше, ptrace - спо&shy;соб при&shy;сут&shy;ству&shy;ю&shy;щий по&shy;чти на всех Linux си&shy;сте&shy;мах, но за&shy;мет&shy;но за&shy;мед&shy;ля&shy;ю&shy;щий ско&shy;рость ис&shy;пол&shy;не&shy;ния. Все это свя&shy;за&shy;но со спе&shy;ци&shy;фи&shy;кой его ра&shy;бо&shy;ты и при&shy;ме&shy;не&shy;ния. Ptrace ис&shy;поль&shy;зу&shy;ет&shy;ся ис&shy;клю&shy;чи&shy;тель&shy;но для от&shy;лад&shy;ки, где не нуж&shy;на боль&shy;шая ско&shy;рость - это раз, во-вто&shy;рых по&shy;сле каж&shy;до&shy;го си&shy;стем&shy;но&shy;го вы&shy;зо&shy;ва до&shy;чер&shy;ний про&shy;цесс при&shy;оста&shy;нав&shy;ли&shy;ва&shy;ет&shy;ся, а мы об&shy;ра&shy;ба&shy;ты&shy;ва&shy;ем SIGTRAP сиг&shy;нал, по&shy;лу&shy;ча&shy;ем int код си&shy;стем&shy;но&shy;го вы&shy;зо&shy;ва, его па&shy;ра&shy;мет&shy;ры, ре&shy;ша&shy;ем, что с этим де&shy;лать и по&shy;сы&shy;ла&shy;ем PTRACE_CONT. Ра&shy;зу&shy;ме&shy;ет&shy;ся, это бу&shy;дет ра&shy;бо&shy;тать бо&shy;лее чем мед&shy;лен&shy;но. При&shy;мер ко&shy;да я при&shy;во&shy;дить не бу&shy;ду, мо&shy;же&shy;те про&shy;сто по&shy;смот&shy;реть ис&shy;ход&shy;ный код <a href="http://strace.git.sourceforge.net/git/gitweb.cgi?p=strace/strace;a=tree">strace</a>. Су&shy;ще&shy;ству&shy;ют де&shy;сят&shy;ки аб&shy;страк&shy;ций во&shy;круг ptrace, я же мо&shy;гу по&shy;со&shy;ве&shy;то&shy;вать <a href="http://dev.exherbo.org/~alip/pinktrace/">pinktrace</a> - хо&shy;ро&shy;шие до&shy;ки и про&shy;стой функ&shy;ци&shy;о&shy;нал де&shy;ко&shy;ди&shy;ро&shy;ва&shy;ния ар&shy;гу&shy;мен&shy;тов основ&shy;ных си&shy;стем&shy;ных вы&shy;зо&shy;вов из ко&shy;роб&shy;ки.</p>
<p>Seccomp был до&shy;бав&shy;лен в яд&shy;ро Linux с вер&shy;сии 2.6.12 и ком&shy;пи&shy;ли&shy;ру&shy;ет&shy;ся с оп&shy;ци&shy;ей CONFIG_SECCOMP в .config. По су&shy;ти, его дей&shy;ствие сво&shy;дит&shy;ся к по&shy;сыл&shy;ке SIGKILL-у про&shy;цес&shy;су при по&shy;пыт&shy;ке вы&shy;пол&shy;нить лю&shy;бые syscall-ы кро&shy;ме exit(), read(), write(), sigreturn(). При этом, read и write мо&shy;гут ис&shy;поль&shy;зо&shy;вать ис&shy;клю&shy;чи&shy;тель&shy;но де&shy;скрип&shy;то&shy;ры, ко&shy;то&shy;рые уже бы&shy;ли от&shy;кры&shy;ты ро&shy;ди&shy;тель&shy;ским про&shy;цес&shy;сом, что нам из&shy;на&shy;чаль&shy;но это не под&shy;хо&shy;дит - мы не по&shy;де&shy;ли&shy;лись этим кон&shy;тек&shy;стом, не пе&shy;ре&shy;дав CLONE_FILES в clone flags. Имен&shy;но seccomp <a href="http://code.google.com/p/seccompsandbox/">ис&shy;поль&shy;зу&shy;ют</a> раз&shy;ра&shy;бот&shy;чи&shy;ки Google Chrome для со&shy;зда&shy;ния пе&shy;соч&shy;ни&shy;цы про&shy;цес&shy;сов бра&shy;у&shy;зе&shy;ра. При этом, все за&shy;пре&shy;щен&shy;ные си&shy;стем&shy;ные вы&shy;зо&shy;вы мо&shy;гут быть ре&shy;а&shy;ли&shy;зо&shy;ва&shy;ны в ко&shy;де. К при&shy;ме&shy;ру, вы мо&shy;же&shy;те на&shy;пи&shy;сать свой или ис&shy;поль&shy;зо&shy;вать сто&shy;рон&shy;ний <a href="http://eli.thegreenplace.net/2008/10/17/memmgr-a-fixed-pool-memory-allocator/">memory manager</a> и так да&shy;лее. При&shy;мер ре&shy;а&shy;ли&shy;за&shy;ции sandbox на осно&shy;ве seccomp в Chromium мо&shy;же&shy;те по&shy;смот&shy;реть по ссыл&shy;ке чуть вы&shy;ше ли&shy;бо же в про&shy;ек&shy;те <a href="https://github.com/nbareil/seccomp-nurse">seccomp-nurse</a>. Это без&shy;опас&shy;ный и до&shy;ста&shy;точ&shy;но бы&shy;стрый спо&shy;соб изо&shy;ля&shy;ции, но слиш&shy;ком слож&shy;ный для ре&shy;а&shy;ли&shy;за&shy;ции.</p>
<p>Но есть и аде&shy;кват&shy;ное усред&shy;нен&shy;ное ре&shy;ше&shy;ние под на&shy;зва&shy;ни&shy;ем seccomp-filters, поз&shy;во&shy;ля&shy;ю&shy;щее обо&shy;зна&shy;чить blacklist или whitelist си&shy;стем&shy;ных вы&shy;зо&shy;вов и по&shy;ве&shy;де&shy;ние про&shy;грам&shy;мы при сов&shy;па&shy;де&shy;нии вы&shy;зо&shy;ва и, что очень важ&shy;но, его па&shy;ра&shy;мет&shy;ров с пер&shy;вым ли&shy;бо же со вто&shy;рым спис&shy;ком. Seccomp filters или seccomp mode 2 по&shy;яви&shy;лись в ядре в вер&shy;сии 3.5, ко&shy;то&shy;рое долж&shy;но быть со&shy;бра&shy;но с па&shy;ра&shy;мет&shy;ром CONFIG_SECCOMP_FILTER. Ис&shy;поль&shy;зо&shy;вать со&shy;ве&shy;тую не на&shy;пря&shy;мую че&shy;рез <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/prctl.2.html">prctl()</a>, а с по&shy;мо&shy;щью биб&shy;лио&shy;те&shy;ки <a href="http://sourceforge.net/projects/libseccomp/">libseccomp</a>. Каж&shy;дый ме&shy;тод име&shy;ет свой де&shy;таль&shy;ный man 2, а в ин&shy;тер&shy;не&shy;тах мож&shy;но най&shy;ти <a href="https://lwn.net/Articles/494252/">опи&shy;са&shy;ние</a> и не&shy;мно&shy;го уста&shy;рев&shy;ший <a href="http://lwn.net/Articles/491308/">при&shy;мер ис&shy;поль&shy;зо&shy;ва&shy;ния</a>.</p>
		</div>

		<hr>
		
		<div class="content_footer hidden-print">
			<p>Что делать, если вы все прочитали и вам понравилось? Можете посмотреть мои остальные статьи в <a href="/blog/archive/">архиве</a> или поделиться радостью со своими воображаемыми друзьями в социальных сетях: <span class="social"><a target="_blank" href="http://www.facebook.com/sharer.php?u=http%3A//www.mindcollapse.com/blog/processes-isolation.html">фейсбук</a>, <a target="_blank" href="http://twitter.com/share?url=http%3A//www.mindcollapse.com/blog/processes-isolation.html&amp;text=%D0%A2%D0%B5%D0%BE%D1%80%D0%B8%D1%8F%20%D0%B8%D0%B7%D0%BE%D0%BB%D1%8F%D1%86%D0%B8%D0%B8%20%D0%B8%20%D0%BB%D0%B8%D0%BC%D0%B8%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D0%BE%D0%B2%20%D0%B2%20linux%20userspace&amp;via=middlesizetit">твиттер</a>, <a target="_blank" href="http://vkontakte.ru/share.php?url=http%3A//www.mindcollapse.com/blog/processes-isolation.html">вконтакте</a></span>.</p>
		</div>
	</div>

    </div>   
</body>

</html>
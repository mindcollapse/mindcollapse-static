<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">

    <title>Делаем свой Google: NodeJS + ElasticSearch</title> 

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="jm8IGIWg4dsm0cTmih0sIVnUaWibc_hpOiQOlqb--9Y"> 
    <meta name="yandex-verification" content="4b85f46617ab1114"> 
    <meta name="y_key" content="04bed234d6a405cc"> 
    <meta name="msvalidate.01" content="62188F55275960794DDFA698C3EA9F05">

    <link rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.ru">
    <link rel="sitemap" href="http://www.mindcollapse.com/blog/sitemap.xml">

    
        <link rel="canonical" href="http://www.mindcollapse.com/blog/264.html">

        <link rel="up archives" href="http://www.mindcollapse.com/blog/archive/">

        
            <link rel="next" href="http://www.mindcollapse.com/blog/262.html">
        

        
            <link rel="prev" href="http://www.mindcollapse.com/blog/265.html">
        

        <meta property="og:title" content="Делаем свой Google: NodeJS + ElasticSearch">
        <meta property="og:description" content="Преж­де чем на­чать оче­ред­ное по­вест­во­ва­ние, ко­то­рое бу­дет аб­со­лют­но не­ин­те­рес­но лю­би­те­лям сме­ху­е­чек (де­ле­га­ция фиш­ки­нет вста­ла и мол­ча вы­шла из за­ла) - не­боль­шое ли­ри­че­ское от­ступ­ле­ние. Мне на мы­ло на­пи­сал чу­вак с за­бав­ным во­про­сом, мол где я, ...">
        <meta property="og:type" content="article">
        <meta property="og:site_name" content="mindcollapse.com">
        <meta property="og:url" content="http://www.mindcollapse.com/blog/264.html">

        <meta name="description" content="Преж­де чем на­чать оче­ред­ное по­вест­во­ва­ние, ко­то­рое бу­дет аб­со­лют­но не­ин­те­рес­но лю­би­те­лям сме­ху­е­чек (де­ле­га­ция фиш­ки­нет вста­ла и ...">

        <meta name="twitter:card" content="summary">
        <meta name="twitter:creator" content="@middlesizetit">
        <meta name="twitter:description" content="Преж­де чем на­чать оче­ред­ное по­вест­во­ва­ние, ко­то­рое бу­дет аб­со­лют­но не­ин­те­рес­но лю­би­те­лям сме­ху­е­чек (де­ле­га­ция фиш­ки­нет вста­ла и мол­ча вы­шла из за­ла) - не­боль­шое ...">
        <meta name="twitter:title" content="Делаем свой Google: NodeJS + ElasticSearch">
    

    <link rel="author" href="https://plus.google.com/110904145311662435301">
    <link rel="icon" href="http://www.mindcollapse.com/favicon.ico" type="image/vnd.microsoft.icon">
    <link rel="alternate" type="application/atom+xml" title="RSS лента mindcollapse.com" href="http://www.mindcollapse.com/blog.xml"> 

    
        <link href="/static/compiled/blog.css?f55bb245" rel="stylesheet" media="all">
    

    
        <script type="text/javascript" src="/static/compiled/blog.js?f97a9d7b"></script>
    

    <!--[if lt IE 9]>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.js"></script>
    <![endif]-->
</head>

<body class="mindcollapse">
    <div class="container">

        <div class="header navbar navbar-default hidden-print" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".blogmenu">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a href="/" class="navbar-brand">Владимир Смирнов</a>
            </div>

            <div class="collapse navbar-collapse blogmenu">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/">Блог</a></li>
                    <li ><a href="/blog/archive/">Архив</a></li>
                    <li><a target="_blank" href="/moho/">Кино</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a target="_blank" href="http://www.twitter.com/middlesizetit">Twitter</a></li>
                    <li><a target="_blank" href="https://github.com/mindcollapse">GitHub</a></li>
                    <li><a href="http://www.mindcollapse.com/blog.xml">RSS</a></li>
                </ul>
            </div>
        </div>

        
	<div class="article hentry" id="post_" itemscope itemtype="http://schema.org/BlogPosting" role="main">
		<div class="content_header clearfix">
			<h1 itemprop="name" class="entry-title pull-left"><a itemprop="url" href="http://www.mindcollapse.com/blog/264.html">Делаем свой Google: NodeJS + ElasticSearch</a></h1>
			<div class="published pull-right"><time itemprop="datePublished" datetime="2011-08-07T00:00:00Z" class="text-muted updated">7 августа 2011 г.</time></div>
		</div>

		<hr class="first">

		<div itemprop="articleBody" class="entry-content content">
			<p>Преж&shy;де чем на&shy;чать оче&shy;ред&shy;ное по&shy;вест&shy;во&shy;ва&shy;ние, ко&shy;то&shy;рое бу&shy;дет аб&shy;со&shy;лют&shy;но не&shy;ин&shy;те&shy;рес&shy;но лю&shy;би&shy;те&shy;лям сме&shy;ху&shy;е&shy;чек (де&shy;ле&shy;га&shy;ция фиш&shy;ки&shy;нет вста&shy;ла и мол&shy;ча вы&shy;шла из за&shy;ла) - не&shy;боль&shy;шое ли&shy;ри&shy;че&shy;ское от&shy;ступ&shy;ле&shy;ние. Мне на мы&shy;ло на&shy;пи&shy;сал чу&shy;вак с за&shy;бав&shy;ным во&shy;про&shy;сом, мол где я, ве&shy;зу&shy;чий су&shy;кин сын, на&shy;хо&shy;жу столь&shy;ко про&shy;ек&shy;тов под ма&shy;ло&shy;из&shy;вест&shy;ный и&nbsp;не&shy;рас&shy;про&shy;стра&shy;нен&shy;ный&nbsp;но&shy;де. От&shy;ве&shy;чаю: про&shy;ек&shy;тов под эту плат&shy;фор&shy;му прак&shy;ти&shy;че&shy;ски нет, язы&shy;ком про&shy;грам&shy;ми&shy;ро&shy;ва&shy;ния это на&shy;звать не&shy;льзя, это ско&shy;рее server-side runtime environment для javascript, ин&shy;стру&shy;мен&shy;та&shy;рий для ре&shy;ше&shy;ния опре&shy;де&shy;лен&shy;но&shy;го кру&shy;га за&shy;дач. Ме&shy;ня на&shy;хо&shy;дят со&shy;вер&shy;шен&shy;но по дру&shy;гим кри&shy;те&shy;ри&shy;ям (мой рост, со&shy;от&shy;но&shy;ше&shy;ние раз&shy;ме&shy;ра ступ&shy;ни к диа&shy;мет&shy;ру зрач&shy;ка, мо&shy;гу го&shy;во&shy;рить, как Ста&shy;ло&shy;не, ну вы по&shy;ня&shy;ли), я лишь вы&shy;би&shy;раю NodeJS для ре&shy;а&shy;ли&shy;за&shy;ции. А мог бы вы&shy;би&shy;рать ер&shy;лан&shy;гов&shy;ские <a href="https://github.com/mochi/mochiweb" title="">Mochiweb</a>, <a href="https://github.com/ostinelli/misultin" title="">Misultin</a>, <a href="https://github.com/extend/cowboy" title="">Cowboy</a> (по&shy;ка&shy;зы&shy;ва&shy;ю&shy;щие да&shy;же бо&shy;лее бы&shy;стрые ре&shy;зуль&shy;та&shy;ты) или пай&shy;то&shy;нов&shy;ский <a href="http://www.tornadoweb.org/" title="">Tornadoweb</a>, но мне род&shy;ной JS как-то бли&shy;же к те&shy;лу, к то&shy;му же под не&shy;го есть от&shy;лич&shy;ный ре&shy;по&shy;зи&shy;та&shy;рий го&shy;то&shy;вых ве&shy;ло&shy;си&shy;пе&shy;дов на все слу&shy;чаи жиз&shy;ни под на&shy;зва&shy;ни&shy;ем <a href="http://npmjs.org/" title="">NPM</a>. Хо&shy;тя, воз&shy;мож&shy;но, в бли&shy;жай&shy;шем бу&shy;ду&shy;щем тут по&shy;явят&shy;ся по&shy;сты и про вы&shy;ше&shy;на&shy;зван&shy;ные тех&shy;но&shy;ло&shy;гии. Ин&shy;те&shy;рес&shy;но? <a href="http://www.mindcollapse.com/blog/264.html" title="">Жми на +1</a>.</p><p>Итак, как ме&shy;ня учи&shy;ли в <a href="http://www.mindcollapse.com/blog/230.html" title="">гу&shy;ма&shy;ни&shy;тар&shy;ном ВУ&shy;Зе</a>, на&shy;чнем с по&shy;ста&shy;нов&shy;ки про&shy;бле&shy;ма&shy;ти&shy;ки. Ко мне обра&shy;тил&shy;ся мой зна&shy;ко&shy;мый, под&shy;ряд&shy;чик од&shy;ной круп&shy;ной фир&shy;мы в Бри&shy;та&shy;нии со сле&shy;ду&shy;ю&shy;щим во&shy;про&shy;сом: есть 40 GB до&shy;ку&shy;мен&shy;тов в HTML фор&shy;ма&shy;те (при бли&shy;жай&shy;шем рас&shy;смот&shy;ре&shy;нии, раз&shy;мер со&shy;кра&shy;тил&shy;ся до 18 GB, что то&shy;же не&shy;ма&shy;ло, столь&shy;ко при&shy;мер&shy;но ве&shy;сит html дамп рус&shy;ско&shy;языч&shy;ной ви&shy;ки&shy;пе&shy;дии со&shy;сто&shy;я&shy;ни&shy;ем на 2008 год), ин&shy;фор&shy;ма&shy;ция край&shy;не кон&shy;фи&shy;ден&shy;ци&shy;аль&shy;ная (днев&shy;ни&shy;ки прин&shy;цесс и ко&shy;ро&shy;лей, ага) и&nbsp;со&shy;би&shy;ра&shy;лась&nbsp;за сто&shy;лет&shy;нюю ис&shy;то&shy;рию ком&shy;па&shy;нии, лет 5-6 то&shy;му на&shy;зад фир&shy;ма пе&shy;ре&shy;шла на ка&shy;кую-то свою си&shy;сте&shy;му хра&shy;не&shy;ния до&shy;ку&shy;мен&shy;та&shy;ции, но ста&shy;рый дамп остал&shy;ся ста&shy;тич&shy;ным и тре&shy;бо&shy;вал ин&shy;дек&shy;са&shy;ции для по&shy;ис&shy;ка по не&shy;му. Ин&shy;тра&shy;нет не поз&shy;во&shy;лял ис&shy;поль&shy;зо&shy;вать Google, им&shy;пор&shy;ти&shy;ро&shy;вать все в но&shy;вую си&shy;сте&shy;му до&shy;ку&shy;мен&shy;то&shy;обо&shy;ро&shy;та ни&shy;кто не хо&shy;тел, ко&shy;му ну&shy;жен ин&shy;фор&shy;ма&shy;ци&shy;он&shy;ный му&shy;сор при ка&shy;кие-то ре&shy;зуль&shy;та&shy;ты са&shy;ни&shy;тар&shy;ных ана&shy;ли&shy;зов во&shy;ды в Нью-Гэмп&shy;ши&shy;ре за 1928 год? Нуж&shy;но от&shy;дать долж&shy;ное со&shy;труд&shy;ни&shy;кам этой кон&shy;то&shy;ры, они усерд&shy;но оциф&shy;ро&shy;вы&shy;ва&shy;ли все и тол&shy;ко&shy;во со&shy;став&shy;ля&shy;ли ка&shy;та&shy;ло&shy;ги вруч&shy;ную, а зна&shy;чит к каж&shy;до&shy;му до&shy;ку&shy;мен&shy;ту был до&shy;ступ по ка&shy;кой-то ги&shy;пер&shy;с&shy;сыл&shy;ке с дру&shy;гой стра&shy;ни&shy;цы. Го&shy;то&shy;вые ре&shy;ше&shy;ния я да&shy;же не ис&shy;кал по опре&shy;де&shy;лен&shy;ным тех&shy;ни&shy;че&shy;ским при&shy;чи&shy;нам, бы&shy;ло при&shy;ня&shy;то ре&shy;ше&shy;ние де&shy;лать свой crawler + indexer, что в на&shy;ше вре&shy;мя ока&shy;за&shy;лось впол&shy;не три&shy;ви&shy;аль&shy;ной за&shy;да&shy;чей.</p><p>Са&shy;мо&shy;го па&shy;у&shy;ка, ко&shy;то&shy;рый бу&shy;дет пу&shy;те&shy;ше&shy;ство&shy;вать по пыль&shy;но&shy;му ар&shy;хи&shy;ву, на&shy;пи&shy;сать, как два паль&shy;ца об ас&shy;фальт, об этом мы по&shy;го&shy;во&shy;рим чу&shy;точ&shy;ку поз&shy;же, оста&shy;но&shy;вим&shy;ся луч&shy;ше на тех&shy;но&shy;ло&shy;гии по&shy;ис&shy;ка и хра&shy;не&shy;ния ин&shy;дек&shy;са. Вся&shy;кие ре&shy;ля&shy;ци&shy;он&shy;ные ба&shy;зы дан&shy;ных от&shy;па&shy;ли сра&shy;зу по&shy;сле то&shy;го, как я вы&shy;пол&shy;нил du -sh в ди&shy;рек&shy;то&shy;рии с ка&shy;та&shy;ло&shy;гом. Хо&shy;тел бы&shy;ло по&shy;про&shy;бо&shy;вать сде&shy;лать что-то свое на осно&shy;ве NoSQL, но из всех из&shy;вест&shy;ных мне движ&shy;ков не поз&shy;во&shy;лял мне ис&shy;кать по&shy;доб&shy;ным об&shy;ра&shy;зом (чуть поз&shy;же я слу&shy;чай&shy;но на&shy;ткнул&shy;ся на <a href="http://wiki.basho.com/Riak-Search.html" title="">Riak</a>, увы, бы&shy;ло уже позд&shy;но), толь&shy;ко MongoDB мог по&shy;хва&shy;стать&shy;ся под&shy;держ&shy;кой ре&shy;гу&shy;ля&shy;рок при вы&shy;бор&shy;ке, а про пол&shy;но&shy;цен&shy;ный же full text и речь не шла, в <a href="http://www.mongodb.org/display/DOCS/Full+Text+Search+in+Mongo" title="">офи&shy;ци&shy;аль&shy;ном ма&shy;нуа&shy;ле</a> со&shy;ве&shy;то&shy;ва&shy;ли раз&shy;би&shy;вать текст на клю&shy;че&shy;вые сло&shy;ва, но это ужас&shy;ное ре&shy;ше&shy;ние. Имен&shy;но по&shy;это&shy;му бы&shy;ло при&shy;ня&shy;то ре&shy;ше&shy;ние хо&shy;тя бы здесь не изоб&shy;ре&shy;тать двух&shy;ко&shy;лес&shy;ные ме&shy;ха&shy;низ&shy;мы и ис&shy;поль&shy;зо&shy;вать го&shy;то&shy;вые удоб&shy;ные ре&shy;ше&shy;ния. Я успел по&shy;смот&shy;реть на <a href="http://lucene.apache.org/solr/" title="">Apache Solr</a> и <a href="http://www.elasticsearch.org/" title="">ElasticSearch</a>, ко&shy;то&shy;рые по&shy;стро&shy;е&shy;ны на <a href="http://lucene.apache.org/java/docs/index.html" title="">Java Lucene</a> и на <a href="http://sphinxsearch.com/" title="">Sphinx</a>. По&shy;след&shy;ний сра&shy;зу от&shy;пал, так как его пре&shy;иму&shy;ще&shy;ства в ви&shy;де не&shy;нуж&shy;ных мне ин&shy;дек&shy;са&shy;ции SQL баз дан&shy;ных и сво&shy;е&shy;го Query Language для слож&shy;ных вы&shy;бо&shy;рок бы&shy;ли све&shy;де&shy;ны на нет не&shy;об&shy;хо&shy;ди&shy;мо&shy;стью пи&shy;сать от&shy;дель&shy;ную XML pipe для до&shy;бав&shy;ле&shy;ния ста&shy;ти&shy;ки. Solr, име&shy;ю&shy;щий ве&shy;ли&shy;ко&shy;леп&shy;ный ад&shy;ми&shy;ни&shy;стра&shy;тив&shy;ный ин&shy;тер&shy;фейс, боль&shy;шое ком&shy;мью&shy;ни&shy;ти, воз&shy;мож&shy;ность ин&shy;дек&shy;си&shy;ро&shy;вать DOC и PDF (ну мы и са&shy;ми мо&shy;жем ис&shy;поль&shy;зо&shy;вать Apache Tika в лю&shy;бом дру&shy;гом движ&shy;ке) по&shy;ка&shy;зал&shy;ся ка&shy;ким-то слиш&shy;ком слож&shy;ным для&nbsp;бы&shy;стро&shy;го&nbsp;стар&shy;та и из&shy;бы&shy;точ&shy;ным, плюс ему не хва&shy;та&shy;ло внят&shy;ной до&shy;ку&shy;мен&shy;та&shy;ции (до&shy;ки в wiki это FFFUUUU). По&shy;это&shy;му я и оста&shy;но&shy;вил&shy;ся на ElasticSearch, ко&shy;то&shy;рый мо&shy;жет по&shy;хва&shy;стать&shy;ся ве&shy;ли&shy;ко&shy;леп&shy;ным REST API на осно&shy;ве JSON, рус&shy;ской мор&shy;фо&shy;ло&shy;ги&shy;ей из ко&shy;роб&shy;ки, раз&shy;лич&shy;ны&shy;ми тек&shy;сто&shy;вы&shy;ми ана&shy;ли&shy;за&shy;то&shy;ра&shy;ми и воз&shy;мож&shy;но&shy;стью&nbsp;со&shy;че&shy;тать&nbsp;их в лю&shy;бой по&shy;сле&shy;до&shy;ва&shy;тель&shy;но&shy;сти, ли&shy;бо да&shy;же со&shy;зда&shy;вать свои соб&shy;ствен&shy;ные, встро&shy;ен&shy;ны&shy;ми язы&shy;ка&shy;ми скрип&shy;то&shy;ва&shy;ния (js или python) для вы&shy;бор&shy;ки и филь&shy;тра&shy;ции, мно&shy;ги&shy;ми ва&shy;ри&shy;ан&shy;та&shy;ми storage для на&shy;ше&shy;го ин&shy;дек&shy;са, ку&shy;чей па&shy;ра&shy;мет&shy;ров сор&shy;ти&shy;ров&shy;ки и ран&shy;жи&shy;ро&shy;ва&shy;ния, под&shy;све&shy;чи&shy;ва&shy;ни&shy;ем ре&shy;зуль&shy;та&shy;тов, wildcard за&shy;про&shy;са&shy;ми и AND, OR клю&shy;че&shy;вы&shy;ми сло&shy;ва&shy;ми, про&shy;стым со&shy;зда&shy;ни&shy;ем кла&shy;сте&shy;ра и ре&shy;пли&shy;ка&shy;ци&shy;ей меж&shy;ду но&shy;да&shy;ми, да&shy;же воз&shy;мож&shy;ность ис&shy;поль&shy;зо&shy;ва&shy;ния по&shy;ис&shy;ко&shy;во&shy;го движ&shy;ка в ка&shy;че&shy;стве key-value хра&shy;ни&shy;ли&shy;ща дан&shy;ных при пра&shy;виль&shy;ном мап&shy;пин&shy;ге. И да, все ра&shy;бо&shy;та&shy;ет без ма&shy;лей&shy;шей кон&shy;фи&shy;гу&shy;ра&shy;ции в сти&shy;ле load`n`run, я толь&shy;ко из&shy;ме&shy;нил&nbsp;network.host на 127.0.0.1 и по&shy;сле за&shy;пус&shy;ка по&shy;лу&shy;чил ра&shy;бо&shy;та&shy;ю&shy;щее хра&shy;ни&shy;ли&shy;ще на&shy;ше&shy;го ин&shy;дек&shy;са. А еще у ела&shy;сти&shy;ка есть, если и не иде&shy;аль&shy;ная, то хо&shy;тя бы внят&shy;ная <a href="http://www.elasticsearch.org/guide/" title="">до&shy;ку&shy;мен&shy;та&shy;ция</a>&nbsp;и кру&shy;тое Java API, ко&shy;то&shy;рое, впро&shy;чем, нам не по&shy;на&shy;до&shy;бит&shy;ся.</p><p>Те&shy;перь мо&shy;жем пе&shy;ре&shy;хо&shy;дить не&shy;по&shy;сред&shy;ствен&shy;но к на&shy;пи&shy;са&shy;нию на&shy;ше&shy;го crawler-а, ко&shy;то&shy;рый бу&shy;дет пе&shy;ре&shy;хо&shy;дить по ссыл&shy;кам и от&shy;прав&shy;лять дан&shy;ные в ElasticSearch. Преж&shy;де все&shy;го, я на&shy;пи&shy;сал свою оберт&shy;ку во&shy;круг RESTа ела&shy;сти&shy;ка для об&shy;лег&shy;че&shy;ния про&shy;цес&shy;са ин&shy;дек&shy;са&shy;ции и по&shy;ис&shy;ка, она очень про&shy;стая и ре&shy;а&shy;ли&shy;зу&shy;ет толь&shy;ко функ&shy;ци&shy;о&shy;нал двух функ&shy;ций - index (плюс update) и search. Код об&shy;вяз&shy;ки <a href="http://lab.mindcollapse.com/NodeCrawler/elasticWrapper.js" title="">мож&shy;но по&shy;смот&shy;реть</a>. Его мы бу&shy;дем ис&shy;поль&shy;зо&shy;вать, как в на&shy;шем по&shy;ис&shy;ко&shy;вом бо&shy;те, так и в сер&shy;вер&shy;ном при&shy;ло&shy;же&shy;нии, воз&shy;вра&shy;ща&shy;ю&shy;щем от&shy;вет поль&shy;зо&shy;ва&shy;те&shy;лю. Те&shy;перь не&shy;по&shy;сред&shy;ствен&shy;но о пре&shy;иму&shy;ще&shy;ствах NodeJS в этой сфе&shy;ре. Преж&shy;де все&shy;го, это муль&shy;ти&shy;по&shy;точ&shy;ность из ко&shy;роб&shy;ки, ра&shy;зу&shy;ме&shy;ет&shy;ся, на всех со&shy;вре&shy;мен&shy;ных язы&shy;ках мож&shy;но до&shy;бить&shy;ся ана&shy;ло&shy;гич&shy;но&shy;го ре&shy;зуль&shy;та&shy;та (ну раз&shy;ве что кро&shy;ме по&shy;ха&shy;пе, но оно там аб&shy;со&shy;лют&shy;но не нуж&shy;но); и, вто&shy;рой по зна&shy;чи&shy;мо&shy;сти плюс, - jQuery. Да, я не опе&shy;ча&shy;тал&shy;ся, мы бу&shy;дем ис&shy;поль&shy;зо&shy;вать се&shy;лек&shy;то&shy;ры и мо&shy;ди&shy;фи&shy;ка&shy;то&shy;ры jquery на сер&shy;вер&shy;сай&shy;де. Все это воз&shy;мож&shy;но бла&shy;го&shy;да&shy;ря ве&shy;ли&shy;ко&shy;леп&shy;ной биб&shy;лио&shy;те&shy;ки <a href="https://github.com/tmpvar/jsdom" title="">JSDOM</a>, ко&shy;то&shy;рая поз&shy;во&shy;ля&shy;ет нам по&shy;лу&shy;чить вир&shy;ту&shy;аль&shy;ный DOM из ко&shy;да HTML раз&shy;мет&shy;ки и эму&shy;ли&shy;ро&shy;вать все вы&shy;зо&shy;вы к не&shy;му. По&shy;че&shy;му jQuery? От&shy;вет прост - ба&shy;наль&shy;ная лень в ущерб опре&shy;де&shy;лен&shy;ной про&shy;из&shy;во&shy;ди&shy;тель&shy;но&shy;сти, ко&shy;неч&shy;но же мы мо&shy;жем ис&shy;поль&shy;зо&shy;вать ре&shy;гу&shy;ляр&shy;ки для вы&shy;бор&shy;ки всех ссыл&shy;кок, но $('a').each() вы&shy;гля&shy;дит про&shy;ще и сим&shy;па&shy;тич&shy;ней. Столк&shy;нул&shy;ся с не&shy;обыч&shy;ной про&shy;бле&shy;мой, ко&shy;то&shy;рая опи&shy;са&shy;на в том чис&shy;ле и в ко&shy;де са&shy;мо&shy;го крау&shy;ле&shy;ра: ElasticSearch по&shy;че&shy;му-то на&shy;от&shy;рез иг&shy;но&shy;ри&shy;ро&shy;вал точ&shy;ки, двое&shy;то&shy;чия, слешы и про&shy;чие сим&shy;во&shy;лы, по&shy;это&shy;му сде&shy;лать про&shy;вер&shy;ку ста&shy;ту&shy;са ин&shy;дек&shy;са&shy;ции ссыл&shy;ки че&shy;рез ее url не по&shy;лу&shy;чи&shy;лось, для этой це&shy;ли ис&shy;поль&shy;зу&shy;ет&shy;ся md5 хэш. В це&shy;лом, по&shy;лу&shy;чи&shy;лось до&shy;ста&shy;точ&shy;но бы&shy;строе ре&shy;ше&shy;ние, дан&shy;ный блог, скорм&shy;лен&shy;ный сво&shy;ей глав&shy;ной стра&shy;ни&shy;цей на&shy;ше&shy;му бо&shy;ту, был пол&shy;но&shy;стью до&shy;бав&shy;лен в кеш ела&shy;сти&shy;ка за пол&shy;то&shy;ры ми&shy;ну&shy;ты все&shy;го-то в 3 по&shy;то&shy;ка. Я ста&shy;рал&shy;ся, по ме&shy;ре воз&shy;мож&shy;но&shy;сти, ком&shy;мен&shy;ти&shy;ро&shy;вать <a href="http://lab.mindcollapse.com/NodeCrawler/crawler.js" title="">ис&shy;ход&shy;ный код</a>, на&shy;де&shy;юсь, что у вас не воз&shy;ник&shy;нет про&shy;блем с его чте&shy;ни&shy;ем. В иде&shy;а&shy;ле, я со&shy;ве&shy;тую ис&shy;поль&shy;зо&shy;вать 10 по&shy;то&shy;ков с&nbsp;queueInterval око&shy;ло 100, если ва&shy;ши се&shy;те&shy;вая под&shy;си&shy;сте&shy;ма и про&shy;цес&shy;сор вы&shy;дер&shy;жат по&shy;доб&shy;ные вы&shy;со&shy;кие на&shy;груз&shy;ки, с та&shy;ки&shy;ми зна&shy;че&shy;ни&shy;я&shy;ми мне уда&shy;ва&shy;лось ин&shy;дек&shy;си&shy;ро&shy;вать око&shy;ло трех&shy;сот стра&shy;ниц ви&shy;ки&shy;пе&shy;дии в ми&shy;ну&shy;ту на сред&shy;нень&shy;ком же&shy;ле&shy;зе и ка&shy;на&shy;ле в 30 mbit\s. Па&shy;ук про&shy;ве&shy;ря&shy;ет вхо&shy;жде&shy;ние до&shy;ме&shy;на ин&shy;дек&shy;си&shy;ру&shy;е&shy;мой ссыл&shy;ки в раз&shy;ре&shy;шен&shy;ный спи&shy;сок и ищет доз&shy;во&shy;лен&shy;ный content-type в от&shy;ве&shy;те, ре&shy;а&shy;ли&shy;зу&shy;ет свое&shy;об&shy;раз&shy;ный robots.txt при по&shy;мо&shy;щи мас&shy;си&shy;ва ре&shy;гу&shy;ля&shy;рок&nbsp;indexQueryPath. К то&shy;му же воз&shy;мож&shy;на пе&shy;ре&shy;ин&shy;дек&shy;са&shy;ция при до&shy;сти&shy;же&shy;нии опре&shy;де&shy;лен&shy;но&shy;го воз&shy;рас&shy;та ин&shy;дек&shy;са, у ме&shy;ня, по умол&shy;ча&shy;нию, это 100 дней.&nbsp;Про&shy;цесс ин&shy;дек&shy;са&shy;ции в ва&shy;шей кон&shy;со&shy;ли бу&shy;дет вы&shy;гля&shy;деть&nbsp;<a href="http://lab.mindcollapse.com/NodeCrawler/NodeCrawler_output.png" title="">как-то так</a>.&nbsp;Ра&shy;бо&shy;та&shy;ю&shy;щий скрипт в memory leaks за&shy;ме&shy;чен не был, но вот JSDOM и jQuery очень лю&shy;бят про&shy;цес&shy;сор, будь&shy;те го&shy;то&shy;вы к вы&shy;со&shy;ким на&shy;груз&shy;кам. Для де&shy;мон&shy;стра&shy;ции я про&shy;шер&shy;стил этот бло&shy;жек и на&shy;пи&shy;сал не&shy;боль&shy;шое при&shy;ло&shy;же&shy;ние по&shy;ис&shy;ка по всем по&shy;стам, со&shy;сто&shy;я&shy;щее из та&shy;кой вот <a href="http://lab.mindcollapse.com/NodeCrawler/index.js" title="">сер&shy;вер&shy;ной ча&shy;сти</a>. Его ра&shy;бо&shy;ту мож&shy;но по&shy;смот&shy;реть в ла&shy;бо&shy;ра&shy;то&shy;рии им. Бе&shy;на Ган&shy;на <a href="http://lab.mindcollapse.com/NodeCrawler/" title="">по ссыл&shy;ке</a>.</p><p>В за&shy;клю&shy;че&shy;ние, хо&shy;чу вы&shy;ра&shy;зить бла&shy;го&shy;дар&shy;ность раз&shy;ра&shy;бот&shy;чи&shy;кам и со&shy;об&shy;ще&shy;ству NodeJS и ElasticSearch. При всей мо&shy;ей <a href="http://www.mindcollapse.com/blog/257.html" title="">не&shy;лю&shy;бви</a> к крас&shy;но&shy;гла&shy;зо&shy;му opensource, два этих ве&shy;ли&shy;ко&shy;леп&shy;ных про&shy;грамм&shy;ных про&shy;дук&shy;та, со&shy;зда&shy;ва&shy;е&shy;мых на чи&shy;стом эн&shy;ту&shy;зи&shy;аз&shy;ме, по&shy;мо&shy;гли мне сде&shy;лать ра&shy;бо&shy;ту в срок, об&shy;ра&shy;до&shy;вать вы&shy;чур&shy;ных бри&shy;тан&shy;цев и ку&shy;пить но&shy;вую до&shy;зу ге&shy;ро&shy;и&shy;на. Очень слож&shy;но за&shy;тя&shy;ги&shy;вать жгут на ру&shy;ке и пи&shy;сать сю&shy;да, до но&shy;вых встреч, дру&shy;зья.</p>
		</div>

		<hr>
		
		<div class="content_footer hidden-print">
			<p>Что делать, если вы все прочитали и вам понравилось? Можете посмотреть мои остальные статьи в <a href="/blog/archive/">архиве</a> или поделиться радостью со своими воображаемыми друзьями в социальных сетях: <span class="social"><a target="_blank" href="http://www.facebook.com/sharer.php?u=http%3A//www.mindcollapse.com/blog/264.html">фейсбук</a>, <a target="_blank" href="http://twitter.com/share?url=http%3A//www.mindcollapse.com/blog/264.html&amp;text=%D0%94%D0%B5%D0%BB%D0%B0%D0%B5%D0%BC%20%D1%81%D0%B2%D0%BE%D0%B9%20Google%3A%20NodeJS%20%2B%20ElasticSearch&amp;via=middlesizetit">твиттер</a>, <a target="_blank" href="http://vkontakte.ru/share.php?url=http%3A//www.mindcollapse.com/blog/264.html">вконтакте</a></span>.</p>
		</div>
	</div>

    </div>   
</body>

</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">

    <title>Пишем свой web анонимайзер с пасьянсом и блудницами</title> 

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="jm8IGIWg4dsm0cTmih0sIVnUaWibc_hpOiQOlqb--9Y"> 
    <meta name="yandex-verification" content="4b85f46617ab1114"> 
    <meta name="y_key" content="04bed234d6a405cc"> 
    <meta name="msvalidate.01" content="62188F55275960794DDFA698C3EA9F05">

    
        <link rel="canonical" href="http://www.mindcollapse.com/blog/253.html">

        <meta property="og:title" content="Пишем свой web анонимайзер с пасьянсом и блудницами">
        <meta property="og:description" content="В ка­че­стве пре­ды­сто­рии: я в по­те ли­ца и про­чих не ме­нее не­удач­ных ча­стей сво­е­го брен­но­го те­ла ра­бо­таю на сла­ву, про­цве­та­ние и до­брое имя ком­па­нии, ко­то­рая за­ни­ма­ет­ся раз­ра­бот­кой &#34;убий­цы http://hidemyass.com/&#34; и до­бро­го де­сят­ка по­доб­ных ему сер­ви­сов. О ...">
        <meta property="og:type" content="article">
        <meta property="og:site_name" content="mindcollapse.com">
        <meta property="og:url" content="http://www.mindcollapse.com/blog/253.html">

        <meta name="description" content="В ка­че­стве пре­ды­сто­рии: я в по­те ли­ца и про­чих не ме­нее не­удач­ных ча­стей сво­е­го брен­но­го те­ла ра­бо­таю на сла­ву, про­цве­та­ние и до­брое ...">

        <meta name="twitter:card" content="summary">
        <meta name="twitter:creator" content="@middlesizetit">
        <meta name="twitter:description" content="В ка­че­стве пре­ды­сто­рии: я в по­те ли­ца и про­чих не ме­нее не­удач­ных ча­стей сво­е­го брен­но­го те­ла ра­бо­таю на сла­ву, про­цве­та­ние и до­брое имя ком­па­нии, ко­то­рая за­ни­ма­ет­ся ...">
        <meta name="twitter:title" content="Пишем свой web анонимайзер с пасьянсом и блудницами">
    

    <link rel="author" href="https://plus.google.com/110904145311662435301">
    <link rel="icon" href="http://www.mindcollapse.com/favicon.ico" type="image/vnd.microsoft.icon">
    <link rel="alternate" type="application/rss+xml" title="RSS лента mindcollapse.com" href="http://www.mindcollapse.com/blog.xml"> 

    
        <link href="/static/compiled/blog.css?170eb2ce" rel="stylesheet" media="all">
    

    
        <script type="text/javascript" src="/static/compiled/blog.js?968f2a5c" defer></script>
    

    <!--[if lt IE 9]>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.js"></script>
    <![endif]-->
</head>

<body class="mindcollapse">
    <div class="container">

        <div class="header navbar navbar-default hidden-print" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".blogmenu">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a href="/" class="navbar-brand">Владимир Смирнов</a>
            </div>

            <div class="collapse navbar-collapse blogmenu">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/">Блог</a></li>
                    <li ><a href="/blog/archive/">Архив</a></li>
                    <li><a target="_blank" href="/moho/">Кино</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a target="_blank" href="http://www.twitter.com/middlesizetit">Twitter</a></li>
                    <li><a target="_blank" href="https://github.com/mindcollapse">GitHub</a></li>
                    <li><a href="http://www.mindcollapse.com/blog.xml">RSS</a></li>
                </ul>
            </div>
        </div>

        
	<div class="article" id="post_" itemscope itemtype="http://schema.org/BlogPosting">
		<div class="content_header clearfix">
			<h1 itemprop="name" class="pull-left">Пишем свой web анонимайзер с пасьянсом и блудницами</h1>
			<div class="published pull-right"><span title="опубликован 934 дня назад" class="text-muted">4 апреля 2011 г.</span></div>
		</div>

		<hr class="first">

		<div itemprop="articleBody" class="content">
			В ка&shy;че&shy;стве пре&shy;ды&shy;сто&shy;рии: я в по&shy;те ли&shy;ца и про&shy;чих не ме&shy;нее не&shy;удач&shy;ных ча&shy;стей сво&shy;е&shy;го брен&shy;но&shy;го те&shy;ла ра&shy;бо&shy;таю на сла&shy;ву, про&shy;цве&shy;та&shy;ние и до&shy;брое имя ком&shy;па&shy;нии, ко&shy;то&shy;рая за&shy;ни&shy;ма&shy;ет&shy;ся раз&shy;ра&shy;бот&shy;кой "убий&shy;цы&nbsp;<a href="http://hidemyass.com/">http://hidemyass.com/</a>" и до&shy;бро&shy;го де&shy;сят&shy;ка по&shy;доб&shy;ных ему сер&shy;ви&shy;сов. О раз&shy;вер&shy;ты&shy;ва&shy;нии и струк&shy;ту&shy;ре се&shy;ти vpn сер&shy;ве&shy;ров на ба&shy;зе openvpn, борь&shy;бе с torrent тра&shy;фи&shy;ком, тон&shy;на&shy;ми спам&shy;ма, де&shy;ше&shy;вы&shy;ми vds-ка&shy;ми, ин&shy;дус&shy;ским&nbsp;ан&shy;гло&shy;го&shy;во&shy;ря&shy;щем&nbsp;на ки&shy;тай&shy;ском сап&shy;пор&shy;том и про&shy;чи&shy;ми пре&shy;ле&shy;стя&shy;ми я на&shy;пи&shy;шу чуть поз&shy;же, се&shy;го&shy;дня мы по&shy;го&shy;во&shy;рим с ва&shy;ми об ано&shy;ни&shy;май&shy;зе&shy;ре. Вас ист дас, Фаль&shy;де&shy;мар? Дас ист та&shy;кой се&shy;бе бы&shy;стрый бра&shy;у&shy;зер&shy;ный "прок&shy;си", что-то ти&shy;па&nbsp;<a href="http://www.hidemyass.com/proxy/">http://www.hidemyass.com/proxy/</a>, вы вво&shy;ди&shy;те ссыл&shy;ку, скрипт ска&shy;чи&shy;ва&shy;ет ее и от&shy;да&shy;ет вам, ми&shy;нуя огра&shy;ни&shy;че&shy;ния кор&shy;по&shy;ра&shy;тив&shy;ных firewall-ов на&shy;при&shy;мер или скры&shy;вая ваш user-agent (ко&shy;му в хуй вва&shy;лил&shy;ся ваш юзе&shy;ра&shy;гент, про&shy;сти&shy;те? ох уж эта paranoia™). В <a href="http://ru.wikipedia.org/wiki/Веб-прокси">Пе&shy;де&shy;ви&shy;кии</a> есть мно&shy;го тек&shy;ста по дан&shy;ной те&shy;ме. Как по мне, меж&shy;ду на&shy;ми де&shy;воч&shy;ка&shy;ми, - аб&shy;со&shy;лют&shy;но не&shy;нуж&shy;ная за&shy;тея, учи&shy;ты&shy;вая все слож&shy;но&shy;сти ее функ&shy;ци&shy;о&shy;ни&shy;ро&shy;ва&shy;ния. Но, имей мое мне&shy;ние хоть ка&shy;кой-ли&shy;бо удель&shy;ный вес, мы бы сей&shy;час за&shy;ни&shy;ма&shy;лись про&shy;из&shy;вод&shy;ством рус&shy;ско&shy;го сту&shy;ден&shy;че&shy;ско&shy;го ка&shy;че&shy;ствен&shy;но&shy;го пор&shy;но, а не раз&shy;ра&shy;бот&shy;кой сер&shy;ви&shy;сов ано&shy;ним&shy;но&shy;сти и без&shy;опас&shy;но&shy;сти в се&shy;ти. Что до&shy;ста&shy;точ&shy;но груст&shy;но, спрос на пор&shy;ну&shy;ху все же мно&shy;го боль&shy;ше, яще&shy;таю. Иг&shy;но&shy;ри&shy;ро&shy;ва&shy;ние по&shy;треб&shy;но&shy;стей рын&shy;ка ве&shy;дет нас в глу&shy;хой угол.<p>Хи&shy;хань&shy;ки-ха&shy;хонь&shy;ки, но из&shy;на&shy;чаль&shy;но бы&shy;ли осмот&shy;ре&shy;ны 2 бес&shy;плат&shy;ных ре&shy;ше&shy;ния. <a href="http://sourceforge.net/projects/phpproxy/">PHPproxy</a> и <a href="http://www.glype.com/">Glype</a>. Вот толь&shy;ко&nbsp;как-то не уда&shy;лось мне по&shy;лу&shy;чить до&shy;зу эсте&shy;ти&shy;че&shy;ско&shy;го удо&shy;воль&shy;ствия от вну&shy;трен&shy;но&shy;стей и что са&shy;мое глав&shy;ное - бы&shy;стро&shy;дей&shy;ствия, ну па&shy;ца&shy;ны, 30 ре&shy;гу&shy;ля&shy;рок на 1 стра&shy;ни&shy;цу - как-то слиш&shy;ком, ага. Да и сов&shy;ме&shy;сти&shy;мость с со&shy;вре&shy;мен&shy;ны&shy;ми сай&shy;та&shy;ми, расфу&shy;фе&shy;рен&shy;ны&shy;ми AJAX-ами, остав&shy;ля&shy;ла же&shy;лать луч&shy;ше&shy;го. При&shy;шлось пи&shy;сать соб&shy;ствен&shy;ный ве&shy;ло&shy;си&shy;пед. Сра&shy;зу про&shy;шу про&shy;стить за PHP, увы и ах, но та&shy;ко&shy;вы тре&shy;бо&shy;ва&shy;ния за&shy;каз&shy;чи&shy;ков для "глу&shy;бо&shy;кой ин&shy;те&shy;гра&shy;ции" это&shy;го гов&shy;на в глот&shy;ку сай&shy;та. Преж&shy;де все&shy;го, я от&shy;ка&shy;зал&shy;ся от пе&shy;ре&shy;да&shy;чи URL прок&shy;си&shy;ми&shy;зи&shy;ру&shy;е&shy;мо&shy;го сай&shy;та в GET пе&shy;ре&shy;мен&shy;ной, из&shy;брав бо&shy;лее ин&shy;те&shy;рес&shy;ный путь. Для на&shy;гляд&shy;но&shy;го при&shy;ме&shy;ра, дан&shy;ный блог, от&shy;кры&shy;тый по&shy;сред&shy;ством мо&shy;е&shy;го web-прок&shy;си, вы&shy;гля&shy;дит как https://mindcollapse.com.proxy.domain.com/blabla.html. Плю&shy;сы та&shy;ко&shy;го эле&shy;гант&shy;но&shy;го ре&shy;ше&shy;ния: удоб&shy;ная ра&shy;бо&shy;та с ку&shy;ки&shy;са&shy;ми, ко&shy;то&shy;рые про&shy;сто мож&shy;но на&shy;зна&shy;чать дан&shy;но&shy;му саб&shy;до&shy;ме&shy;ну, а не хра&shy;нить во вре&shy;мен&shy;ных фай&shy;лах, как это де&shy;ла&shy;ли вы&shy;ше&shy;на&shy;зван&shy;ные ре&shy;а&shy;ли&shy;за&shy;ции, лег&shy;кость под&shy;ме&shy;ны ссы&shy;лок в стра&shy;ни&shy;це, в том чис&shy;ле и relative links, ко&shy;то&shy;рые во&shy;об&shy;ще тро&shy;гать не нуж&shy;но. &nbsp;То бишь, мы про&shy;сто до&shy;бав&shy;ля&shy;ем&nbsp;.proxy.domain.com по&shy;сле до&shy;мен&shy;но&shy;го име&shy;ни и на&shy;прав&shy;ля&shy;ем весь тра&shy;фик че&shy;рез наш сер&shy;вер. Те&shy;перь по по&shy;во&shy;ду тех&shy;но&shy;ло&shy;гий ре&shy;а&shy;ли&shy;за&shy;ции. Для на&shy;ча&shy;ла, нам не по&shy;ме&shy;ша&shy;ет wildcard SSL сер&shy;ти&shy;фи&shy;кат с мас&shy;кой *.domain.com. Ну и ни&shy;как не обой&shy;дем&shy;ся без *.proxy A Record на нейм&shy;сер&shy;ве&shy;рах на&shy;ше&shy;го с ва&shy;ми до&shy;ме&shy;на. В апа&shy;чев&shy;ский кон&shy;фиг sites-enabled/proxy.domain.com.conf до&shy;бав&shy;ля&shy;ем&nbsp;ServerAlias *.proxy.domain.com. Пол ра&shy;бо&shy;ты сде&shy;ла&shy;но, те&shy;перь де&shy;ло за ма&shy;лым - на&shy;пи&shy;сать об&shy;ра&shy;бот&shy;чик дан&shy;ных. Преж&shy;де все&shy;го, нам ну&shy;жен пра&shy;виль&shy;ный .htaccess с&nbsp;RewriteRule ^(.*)$ /proxy.php?$1 [L]. Те&shy;перь лю&shy;бые за&shy;про&shy;сы бу&shy;дут ре&shy;врай&shy;тит&shy;ся в REQUEST_URI proxy.php. Не за&shy;бы&shy;ва&shy;ем и про&nbsp;RewriteCond %{REQUEST_FILENAME} !-f, а ина&shy;че по&shy;лу&shy;чи&shy;те веч&shy;ный ре&shy;ди&shy;рект в по&shy;ис&shy;ках сча&shy;стья.&nbsp;</p><p>Ли&shy;ри&shy;че&shy;ское от&shy;ступ&shy;ле&shy;ние по по&shy;во&shy;ду со&shy;дер&shy;жа&shy;ния proxy.php. Я как-то уже дав&shy;нень&shy;ко не под&shy;хо&shy;дил к PHP, все в ком&shy;пи&shy;ли&shy;ру&shy;е&shy;мых язы&shy;ках, да в пер&shy;лах по са&shy;мые лок&shy;ти. Кста&shy;ти, на&shy;счет по&shy;след&shy;не&shy;го, кто там го&shy;во&shy;рит, что перл мертв - по&shy;смот&shy;ри&shy;те на ко&shy;ли&shy;че&shy;ство жи&shy;вых ве&shy;ло&shy;си&shy;пе&shy;дов в CPAN. Од&shy;них толь&shy;ко&nbsp;<a href="http://cpan.uwinnipeg.ca/module/Cache/">ин&shy;тер&shy;фей&shy;сов ке&shy;ши&shy;ро&shy;ва&shy;ния</a>&nbsp;хва&shy;тит да&shy;же чрез&shy;вы&shy;чай&shy;но&nbsp;изо&shy;щрен&shy;но&shy;му&nbsp;уму. Ну а про ско&shy;ро&shy;по&shy;стиж&shy;ную кон&shy;чи&shy;ну кри&shy;чит вся&shy;кая шко&shy;ло&shy;та, чи&shy;та&shy;ю&shy;щая кло&shy;аку вро&shy;де ха&shy;бра&shy;ха&shy;бра и меч&shy;та&shy;ю&shy;щая о за&shy;вет&shy;ном ин&shy;вай&shy;те. Да, есть RubyForge и RubyGems, есть Pypi для мон&shy;ти пай&shy;то&shy;на, да&shy;же C# в Microsoft Visual Studio име&shy;ет ме&shy;не&shy;джер ком&shy;по&shy;нен&shy;тов, а со&shy;всем не&shy;дав&shy;но си&shy;ла&shy;ми ком&shy;мью&shy;ни&shy;ти еще и nuget вы&shy;шел, ко&shy;то&shy;рый я все ни&shy;как не по&shy;смот&shy;рю. И да, есть <a href="http://pear.php.net/packages.php">PEAR</a> для PHP. На&shy;бор биб&shy;лио&shy;тек в нем, мяг&shy;ко го&shy;во&shy;ря, скуд&shy;ный. PEAR "из ко&shy;роб&shy;ки" не да&shy;ет ста&shy;вить па&shy;ке&shy;ты у ко&shy;то&shy;рый ре&shy;лиз ста&shy;тус ни&shy;же stable, а как это от&shy;клю&shy;чить - при&shy;хо&shy;дит&shy;ся гуглить или уста&shy;нав&shy;ли&shy;вать по ссыл&shy;ке, как-то не очень со&shy;по&shy;став&shy;ля&shy;ет&shy;ся дан&shy;ные дей&shy;ствия с опре&shy;де&shy;ле&shy;ни&shy;ем "удоб&shy;но&shy;го ме&shy;не&shy;дже&shy;ра ком&shy;по&shy;нен&shy;тов". Ну да не важ&shy;но, для на&shy;ше&shy;го прок&shy;си мы бу&shy;дем ис&shy;поль&shy;зо&shy;вать об&shy;вяз&shy;ку не во&shy;круг CURL-а, а над&nbsp;fsockopen. На&shy;зы&shy;ва&shy;ет&shy;ся <a href="http://pear.php.net/package/HTTP_Request2">HTTP_Request2</a>.&nbsp;Биб&shy;лио&shy;те&shy;ка, меж&shy;ду про&shy;чим, очень да&shy;же ни&shy;че&shy;го. По&shy;жа&shy;луй, хва&shy;тит хо&shy;дить во&shy;круг да око&shy;ло: вот вам код <a href="/media/copypaste/proxy.php">proxy.php в ко&shy;пи&shy;па&shy;сте&shy;ре</a>. Хо&shy;чу за&shy;ме&shy;тить, что это&nbsp;ско&shy;рее&nbsp;бол&shy;ван&shy;ка из ко&shy;то&shy;рой я уб&shy;рал боль&shy;шу часть ко&shy;да ис&shy;поль&shy;зу&shy;е&shy;мую при раз&shy;бо&shy;ре джа&shy;вас&shy;крип&shy;тов и css, да и до&shy;брый 10к пла&shy;ги&shy;нов, ко&shy;то&shy;рые за&shy;став&shy;ля&shy;ли ра&shy;бо&shy;тать юту&shy;бы и фейс&shy;бу&shy;ки. Ни&shy;че&shy;го там слож&shy;но&shy;го нет, про&shy;сто firebug или chrome developer tools вам в ру&shy;ки и ко&shy;пай&shy;тесь в ку&shy;че не&shy;по&shy;нят&shy;ных ку&shy;ки&shy;сов и сжа&shy;тых js-скрип&shy;тов.&nbsp;Для по&shy;след&shy;них, кста&shy;ти, есть от&shy;лич&shy;ная ути&shy;ли&shy;та -&nbsp;<a href="http://jsbeautifier.org/" style="color:rgb(0,0,255);">JSBeautifier</a>.&nbsp;Так что не нуж&shy;но кри&shy;чать "ха&shy;аа, лох, у те&shy;бя же ни&shy;как не про&shy;ве&shy;ря&shy;ет&shy;ся вво&shy;ди&shy;мый урл, ха&shy;а&shy;аа". Про&shy;ве&shy;ря&shy;ет&shy;ся. Хри&shy;стом бо&shy;гом кля&shy;нусь. У ме&shy;ня все.</p>
		</div>

		<hr>
		
		<div class="content_footer hidden-print">
			<p>Что делать, если вы все прочитали и вам понравилось? Можете посмотреть мои остальные статьи в <a href="/blog/archive/">архиве</a> или поделиться радостью со своими воображаемыми друзьями в социальных сетях: <span class="social"><a target="_blank" href="http://www.facebook.com/sharer.php?u=http%3A//www.mindcollapse.com/blog/253.html">фейсбук</a>, <a target="_blank" href="http://twitter.com/share?url=http%3A//www.mindcollapse.com/blog/253.html&amp;text=%D0%9F%D0%B8%D1%88%D0%B5%D0%BC%20%D1%81%D0%B2%D0%BE%D0%B9%20web%20%D0%B0%D0%BD%D0%BE%D0%BD%D0%B8%D0%BC%D0%B0%D0%B9%D0%B7%D0%B5%D1%80%20%D1%81%20%D0%BF%D0%B0%D1%81%D1%8C%D1%8F%D0%BD%D1%81%D0%BE%D0%BC%20%D0%B8%20%D0%B1%D0%BB%D1%83%D0%B4%D0%BD%D0%B8%D1%86%D0%B0%D0%BC%D0%B8&amp;via=middlesizetit">твиттер</a>, <a target="_blank" href="http://vkontakte.ru/share.php?url=http%3A//www.mindcollapse.com/blog/253.html">вконтакте</a></span>.</p>
		</div>
	</div>

    </div>

    <!-- Yandex.Metrika counter --><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter22151810 = new Ya.Metrika({id:22151810, clickmap:true, trackLinks:true, accurateTrackBounce:true}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="//mc.yandex.ru/watch/22151810" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter -->      
</body>

</html>
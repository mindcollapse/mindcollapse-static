<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">

    <title>Делаем свой собственный Dropbox</title> 

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="jm8IGIWg4dsm0cTmih0sIVnUaWibc_hpOiQOlqb--9Y"> 
    <meta name="yandex-verification" content="4b85f46617ab1114"> 
    <meta name="y_key" content="04bed234d6a405cc"> 
    <meta name="msvalidate.01" content="62188F55275960794DDFA698C3EA9F05">

    <link rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.ru">
    <link rel="sitemap" href="https://www.mindcollapse.com/blog/sitemap.xml">

    
        <link rel="canonical" href="https://www.mindcollapse.com/blog/246.html">

        
            <link rel="next" href="https://www.mindcollapse.com/blog/245.html">
        

        
            <link rel="prev" href="https://www.mindcollapse.com/blog/248.html">
        

        <meta property="og:title" content="Делаем свой собственный Dropbox">
        <meta property="og:description" content="Прежде всего, хочу заметить, что данная статья не претендует ни на уникальность, ни на технологические инновации тем более - использовать мы будем все готовое. Просто в какой-то момент мне стала интересна тема создания своего собственного аналога ...">
        <meta property="og:type" content="article">
        <meta property="og:site_name" content="mindcollapse.com">
        <meta property="og:url" content="https://www.mindcollapse.com/blog/246.html">

        <meta name="description" content="Прежде всего, хочу заметить, что данная статья не претендует ни на уникальность, ни на технологические инновации тем более - ...">

        <meta name="twitter:creator" content="@middlesizetit">
        <meta name="twitter:description" content="Прежде всего, хочу заметить, что данная статья не претендует ни на уникальность, ни на технологические инновации тем более - использовать мы будем все готовое. Просто в ...">
        <meta name="twitter:title" content="Делаем свой собственный Dropbox">

        
            <meta name="twitter:card" content="summary">
        
    

    <link rel="publisher" href="https://plus.google.com/110904145311662435301">
    <link rel="icon" href="https://www.mindcollapse.com/favicon.ico" type="image/vnd.microsoft.icon">
    <link rel="alternate" type="application/atom+xml" title="RSS лента mindcollapse.com" href="https://www.mindcollapse.com/blog.xml"> 

    
        <link href="/static/compiled/blog.css?47e4fb13" rel="stylesheet" media="all">
    

    
        <script type="text/javascript" async src="/static/compiled/blog.js?c6c1320e"></script>
    

    <!--[if lt IE 9]>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.js"></script>
    <![endif]-->
</head>

<body class="mindcollapse">
    <main class="container">
        <header class="header navbar navbar-default hidden-print">
            <nav class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".blogmenu">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a href="/" class="navbar-brand">Владимир Смирнов</a>
            </nav>

            <nav class="collapse navbar-collapse blogmenu" role="navigation">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/">Блог</a></li>
                    <li ><a href="/blog/archive/">Архив</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a target="_blank" href="https://twitter.com/middlesizetit">Twitter</a></li>
                    <li><a target="_blank" href="https://github.com/mindcollapse">GitHub</a></li>
                    <li><a href="https://www.mindcollapse.com/blog.xml">RSS</a></li>
                </ul>
            </nav>
        </header>

        
    <article class="article hentry" itemscope itemtype="http://schema.org/Article" role="main">
        <div class="content_header clearfix">
            <div itemprop="name" class="entry-title pull-left">
                <h1><a itemprop="url" href="https://www.mindcollapse.com/blog/246.html">Делаем свой собственный Dropbox</a></h1>
            </div>

            <div class="published pull-right">
                <time itemprop="datePublished" datetime="2011-01-23T00:00:00Z" class="text-muted updated">23 января 2011 г.</time>
            </div>

            <div class="vcard author hidden">
                <a itemprop="author" class="url fn" href="http://www.mindcollapse.com/">Vladimir Smirnov</a>
            </div>
        </div>

        <hr class="first">

        <div itemprop="description" class="entry-content content">
            Преж­де все­го, хо­чу за­ме­тить, что дан­ная ста­тья не пре­тен­ду­ет ни на уни­каль­ность, ни на тех­но­ло­ги­че­ские ин­но­ва­ции тем бо­лее - ис­поль­зо­вать мы бу­дем все го­то­вое. Про­сто в ка­кой-то мо­мент мне ста­ла ин­те­рес­на те­ма со­зда­ния сво­е­го соб­ствен­но­го ана­ло­га <a href="https://www.dropbox.com">Dropbox</a>-а, по­это­му я ре­шил по­де­лить­ся с ва­ми ре­зуль­та­том, ко­то­рый мож­но ис­поль­зо­вать ис­клю­чи­тель­но для те­стов или даль­ней­ших раз­ра­бо­ток. Ни я, ни со­зда­те­ли unison ни­че­го вам га­ран­ти­ро­вать не мо­жем, но об этом чуть ни­же. Кто не в кур­се, Dropbox - ве­ли­ко­леп­ней­ший стар­тап из всех ны­не су­ще­ству­ю­щих, поз­во­ля­ет син­хро­ни­зи­ро­вать свои фай­лы с уда­лен­ным хра­ни­ли­щем в об­ла­ках Amazon S3. Аб­со­лют­но бес­плат­но мож­но по­лу­чить 2GB, а если за­ре­ги­стри­ро­вать­ся по <a href="http://db.tt/pcQvkUx">мо­ей ре­фе­раль­ной ссыл­ке</a>, то нам обо­им еще на­ки­нет по 250MB. Вро­де и ме­лочь, а при­ят­но. Ре­кла­ма ре­кла­мой, но да­вай­те пе­рей­дем к тех­ни­че­ско­му опи­са­нию.<p></p><p>Де­лать свой ал­го­ритм для diff с по­сле­ду­ю­щим push-pull из­ме­не­ний мы не бу­дем - это слож­но и бес­пер­спек­тив­но, а возь­мем мы го­то­вое ре­ше­ние для син­хро­ни­за­ции ло­каль­ной и уда­лен­ной ди­рек­то­рии под на­зва­ни­ем <a href="http://www.cis.upenn.edu/~bcpierce/unison/">Unison</a>. Очень, кста­ти, не­пло­хое ре­ше­ние, кро­с­плат­фор­мен­ное, со­бра­но под windows, linux и macos, про­стое в на­строй­ке и до­ста­точ­но бы­строе. Есть, прав­да, и свои не­до­стат­ки, при пе­ре­име­но­ва­нии фай­ла в local folder идет уда­ле­ние его на remote ди­рек­то­рии с по­сле­ду­ю­щей пе­ре­за­лив­кой, воз­мож­но, это как-то ле­чит­ся на­строй­ка­ми, при по­верх­ност­ном про­чте­нии я по­доб­ной ин­фор­ма­ции не на­шел. Unison тре­бу­ет на­ли­чие би­нар­ни­ка на кли­ен­те-сер­ве­ре (важ­ный мо­мент, вер­сии обя­за­тель­но долж­ны сов­па­дать) и мо­жет ра­бо­тать в ви­де со­кет-де­мо­на (не под­хо­дит нам из со­об­ра­же­ний без­опас­но­сти, от­сут­ству­ет аутен­ти­фи­ка­ция), по­верх rsync или ssh. Мы бу­дем ис­поль­зо­вать по­след­ний ва­ри­ант для удоб­ства огра­ни­че­ния до­сту­па, от­сут­ствия про­блем с пра­ва­ми до­сту­па, без­опас­ной пе­ре­да­чи и ку­чи дру­гих пре­иму­ществ, ко­то­рые да­ет нам secure shell protocol. Сле­ду­ю­щая труд­ность со­сто­ит в том, что usinon тре­бу­ет би­нар­ник openssh кли­ен­та для сво­ей ра­бо­ты, а мы в на­сто­я­щий мо­мент пи­шем кли­ент для windows, не за­бы­вай­те. Ра­зу­ме­ет­ся, ни­что не ме­ша­ет взять cygwin ском­пи­ли­ро­ван­ную вер­сию, но она у ме­ня как-то кри­во ра­бо­та­ла, не под­дер­жи­ва­ла ин­тер­ак­тив­ную ав­то­ри­за­цию ло­ги­ном и па­ро­лем, и не да­ва­ла ло­ги­нить­ся че­рез rsa_key, рас­ска­зы­вая про insecure file permission, тре­буя chmod-ить его в 0600, а как, про­сти­те, я это в ок­нах сде­лаю? Бла­го, су­ще­ству­ет на­тив­ная CLI вер­сия <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html">PuTTY SSH Client</a> под на­зва­ни­ем Plink.exe, ко­то­рую мы и бу­дем ис­поль­зо­вать. Пря­мое пе­ре­име­но­ва­ние plink.exe в ssh.exe ра­бо­тать не бу­дет, plink не под­дер­жи­ва­ет не­ко­то­рые атри­бу­ты и от­ва­ли­ва­ет­ся с ошиб­кой. В ин­тер­не­те бы­ла най­де­на оберт­ка, ко­то­рая ис­прав­ля­ет дан­ный не­до­ста­ток. Это обыч­ный bat файл, его со­дер­жа­ние <a href="/media/copypaste/ssh2plink.bat">мож­но по­смот­реть</a>. Все, те­перь ни­че­го не ме­ша­ет вам ис­поль­зо­вать дву­сто­рон­нюю син­хро­ни­за­цию с по­мо­щью ко­ман­ды <em>unison.exe C:\local\path\ ssh://host.com/remote/path/ -batch -sshcmd ssh2plink.bat -sshargs "-pw mysshpass -l mysshlogin</em>". Если вы пе­ре­жи­ва­е­те за без­опас­ность, то мож­но на­стро­ить и passwordless ав­то­ри­за­цию. Для это ге­не­ри­руй­те ключ на сер­ве­ре, кон­вер­ти­руй­те его в ppk фор­мат, ко­то­рый ис­поль­зу­ет PuTTY, c по­мо­щью PuTTYgen и го­во­ри­те Plink-у ис­поль­зо­вать этот файл че­рез<em> -sshargs "-i pathtomykey.ppk -l mysshlogin</em>". </p><p></p><p>На этом ка­за­лось бы мож­но бы­ло за­кон­чить, но мы же хо­тим ана­лог дропбок­са, весь кайф ко­то­ро­го за­клю­ча­ет­ся в immediate synchronization: от­кры­ли файл, от­ре­дак­ти­ро­ва­ли его, со­хра­ни­ли и он сра­зу же про­толк­нул­ся на сер­вер. Вот тут нам не обой­тись уже без кли­ен­та, пи­сать его мы бу­дем на Microsoft Visual C# Express. По­че­му? Да про­сто мне так удоб­но, к то­му же в нем по умол­ча­нию есть все не­об­хо­ди­мые нам ин­стру­мен­ты. Основ­ные клас­сы, ко­то­рые мы бу­дем ис­поль­зо­вать: System.Diagnostics.Process для ра­бо­ты с unison.exe и его StandardOutput (ко­то­рый по­че­му-то у ме­ня от­да­вал­ся в StandardError, не­смот­ря на 0 ExitCode про­цес­са), System.IO.FileSystemWatcher для от­сле­жи­ва­ния из­ме­не­ний в ди­рек­то­рии и System.ComponentModel.BackgroundWorker для ра­бо­ты в фо­не. На­бро­сан­ный на ско­рую ру­ку код вы­гля­дит <a href="/media/copypaste/sshbox.cs">сле­ду­ю­щим об­ра­зом</a>. Ну или вот <a href="/media/etc/sshbox.zip">весь про­ект</a> для сбор­ки. А вот го­то­вый <a href="/media/etc/sshbox_bin.zip">би­нар­ник</a>. По­вто­рюсь, все это де­ла­лось на ско­рую ру­ку, но мо­жет стать ба­зой для нор­маль­но­го про­ек­та, если вам это так ин­те­рес­но. Да, кста­ти, usinon под­дер­жи­ва­ет муль­ти­кли­ент­ную син­хро­ни­за­цию с то­по­ло­ги­ей ви­да звез­да, так что, если до­ба­вить тай­мер для син­хро­ни­за­ции, то тут вам и воз­мож­ность ра­бо­тать це­лым код­лом над од­ним фай­лом, прав­да я по­доб­ное не те­сти­ро­вал.</p><p></p><p>Та­ким об­ра­зом, для на­строй­ки сво­е­го сер­ве­ра син­хро­ни­за­ции вам ну­жен уда­лен­ный linux\freebsd сер­вер с ру­том или хо­тя бы воз­мож­но­стью со­би­рать би­нар­ни­ки, оди­на­ко­вые вер­сии unison на обо­их кон­цах (до­ста­точ­но x.xx.000, вер­сия бил­да 000 ни­как не вли­я­ет на сов­ме­сти­мость), оберт­ка для от­сле­жи­ва­ния из­ме­не­ний и вы по­лу­ча­е­те свой ана­лог Dropbox. Я по­вто­рюсь, ана­лог, ко­то­рый вы­пол­ня­ет лишь 50% функ­ций ори­ги­на­ла, но тем не ме­нее мо­жет стать за­ме­ной лю­дям, ко­то­рые не до­ве­ря­ют свои фай­ли­ки ни­ко­му, а весь /home у них мон­ти­ру­ет­ся в EncFS.</p>
        </div>
    </article>

    <hr>

    <footer class="footer hidden-print">
        <p>Что делать, если вы все прочитали и вам понравилось? Можете посмотреть мои остальные статьи в <a href="/blog/archive/">архиве</a> или поделиться ссылкой в <span class="social"><a target="_blank" href="http://www.facebook.com/sharer.php?u=https%3A//www.mindcollapse.com/blog/246.html">фейсбуке</a>, <a target="_blank" href="http://twitter.com/share?url=https%3A//www.mindcollapse.com/blog/246.html&amp;text=%D0%94%D0%B5%D0%BB%D0%B0%D0%B5%D0%BC%20%D1%81%D0%B2%D0%BE%D0%B9%20%D1%81%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9%20Dropbox&amp;via=middlesizetit">твиттере</a> или <a target="_blank" href="http://vkontakte.ru/share.php?url=https%3A//www.mindcollapse.com/blog/246.html">в контакте</a></span>.</p>
    </footer>

    </main>
</body>

</html>
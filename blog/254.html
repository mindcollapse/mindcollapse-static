<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">

    <title>Пишем свой caching nameserver с фильтрацией</title> 

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="jm8IGIWg4dsm0cTmih0sIVnUaWibc_hpOiQOlqb--9Y"> 
    <meta name="yandex-verification" content="4b85f46617ab1114"> 
    <meta name="y_key" content="04bed234d6a405cc"> 
    <meta name="msvalidate.01" content="62188F55275960794DDFA698C3EA9F05">

    <link rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.ru">
    <link rel="sitemap" href="https://www.mindcollapse.com/blog/sitemap.xml">

    
        <link rel="canonical" href="https://www.mindcollapse.com/blog/254.html">

        
            <link rel="next" href="https://www.mindcollapse.com/blog/253.html">
        

        
            <link rel="prev" href="https://www.mindcollapse.com/blog/255.html">
        

        <meta property="og:title" content="Пишем свой caching nameserver с фильтрацией">
        <meta property="og:description" content="Прежде чем начинать свое повествование, маленькое сообщение для всех, кто прочитал топик поста и закачал убеленной сединой\лысиной головой с неприкрытым укором: да, я знаю о существовании BIND и да, я знаю про MySQL BIND SDB, или даже про MyDNS тоже слышал, и ...">
        <meta property="og:type" content="article">
        <meta property="og:site_name" content="mindcollapse.com">
        <meta property="og:url" content="https://www.mindcollapse.com/blog/254.html">

        <meta name="description" content="Прежде чем начинать свое повествование, маленькое сообщение для всех, кто прочитал топик поста и закачал убеленной сединой\лысиной ...">

        <meta name="twitter:creator" content="@middlesizetit">
        <meta name="twitter:description" content="Прежде чем начинать свое повествование, маленькое сообщение для всех, кто прочитал топик поста и закачал убеленной сединой\лысиной головой с неприкрытым укором: да, я ...">
        <meta name="twitter:title" content="Пишем свой caching nameserver с фильтрацией">

        
            <meta name="twitter:card" content="summary">
        
    

    <link rel="publisher" href="https://plus.google.com/110904145311662435301">
    <link rel="icon" href="https://www.mindcollapse.com/favicon.ico" type="image/vnd.microsoft.icon">
    <link rel="alternate" type="application/atom+xml" title="RSS лента mindcollapse.com" href="https://www.mindcollapse.com/blog.xml"> 

    
        <link href="/static/compiled/blog.css?85fbe913" rel="stylesheet" media="all">
    

    
        <script type="text/javascript" src="/static/compiled/blog.js?06c0e12a"></script>
    

    <!--[if lt IE 9]>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.js"></script>
    <![endif]-->
</head>

<body class="mindcollapse">
    <main class="container">
        <header class="header navbar navbar-default hidden-print">
            <nav class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".blogmenu">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <a href="/" class="navbar-brand">Владимир Смирнов</a>
            </nav>

            <nav class="collapse navbar-collapse blogmenu" role="navigation">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/">Блог</a></li>
                    <li ><a href="/blog/archive/">Архив</a></li>
                    <li><a target="_blank" href="/moho/">Кино</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right">
                    <li><a target="_blank" href="http://www.twitter.com/middlesizetit">Twitter</a></li>
                    <li><a target="_blank" href="https://github.com/mindcollapse">GitHub</a></li>
                    <li><a href="https://www.mindcollapse.com/blog.xml">RSS</a></li>
                </ul>
            </nav>
        </header>

        
    <article class="article hentry" itemscope itemtype="http://schema.org/Article" role="main">
        <div class="content_header clearfix">
            <div itemprop="name" class="entry-title pull-left">
                <h1><a itemprop="url" href="https://www.mindcollapse.com/blog/254.html">Пишем свой caching nameserver с фильтрацией</a></h1>
            </div>

            <div class="published pull-right">
                <time itemprop="datePublished" datetime="2011-04-09T00:00:00Z" class="text-muted updated">9 апреля 2011 г.</time>
            </div>

            <div class="vcard author hidden">
                <a itemprop="author" class="url fn" href="http://www.mindcollapse.com/">Vladimir Smirnov</a>
            </div>
        </div>

        <hr class="first">

        <div itemprop="description" class="entry-content content">
            Преж­де чем на­чи­нать свое по­вест­во­ва­ние, ма­лень­кое со­об­ще­ние для всех, кто про­чи­тал то­пик по­ста и за­ка­чал убе­лен­ной се­ди­ной\лы­си­ной го­ло­вой с не­при­кры­тым уко­ром: да, я знаю о су­ще­ство­ва­нии BIND и да, я знаю про MySQL BIND SDB, или да­же про MyDNS то­же слы­шал, и на­стро­ить ке­ши­ру­ю­щий child нейм­сер­вер умею. Увы, ре­а­ли­за­ция та­кой ком­би­на­ции не ви­де­лась мне це­ле­со­об­раз­ной по ря­ду при­чин о ко­то­рых я не бу­ду тут пи­сать. В лю­бом слу­чае, мне нуж­но бы­ло сде­лать DNS с филь­тра­ци­ей опре­де­лен­ных до­мен­ных имен с хра­не­ни­ем спис­ка этих имен на цен­траль­ном сер­ве­ре в MySQL ба­зе дан­ных. Нуж­но бы­ло сде­лать его не на­мно­го мед­лен­ней род­но­го ва­ри­ан­та, что бы­ло впол­не не­три­ви­аль­ной за­да­чей. Ду­маю, что для на­ча­ла мне сто­ит объ­яс­нить, за­чем это все за­ду­мы­ва­лось. Как упо­ми­на­лось в про­шлом по­сте, я ра­бо­таю в ком­па­нии основ­ным на­прав­ле­ние де­я­тель­но­сти ко­то­рой яв­ля­ет­ся предо­став­ле­ние сер­ви­са за­щи­щен­но­го VPN тун­не­ля для об­хо­да кор­по­ра­тив­ных фа­ер­во­лов, шиф­ро­ва­ния тра­фи­ка, за­щи­ты от man-in-the-middle и про­чих мерз­ких сниф­фе­ров, по­лу­че­ния сво­е­го лич­но­го ре­аль­но­го IP где-то в стра­нах эк­ва­то­ри­аль­ной Аме­ри­ки, ну и для за­щи­ты от ви­ру­сов с по­мо­щью ре­ше­ний от тов. Ка­спер­ско­го. В ка­че­стве сер­вер­ных пло­ща­док ис­поль­зу­ют­ся раз­но­об­раз­ные virtual dedicated и root dedicated от раз­ных про­вай­де­ров по все­му ми­ру. И вот тут воз­ни­ка­ет основ­ная про­бле­ма, ко­то­рая за­гу­би­ла боль­шин­ство по­доб­ных сер­ви­сов - тор­рен­ты. Да, в боль­шин­стве TOS-ов боль­шин­ства хо­сте­ров яс­но про­пи­са­но, что если с ва­ше­го сер­ве­ра бу­дет за­ме­че­на по­до­зри­тель­ная ак­тив­ность по за­груз­ке из ин­тер­не­та не­ле­галь­но­го кон­тен­та, то вы ав­то­ма­ти­че­ски ли­ша­е­тесь предо­став­ля­е­мой услу­ги без ка­кой-ли­бо на­де­жды на ма­те­ри­аль­ное воз­ме­ще­ние. Зву­чит до­ста­точ­но пе­чаль­но, учи­ты­вая пре­до­пла­ту на це­лый год. В ито­ге, ча­сто по­лу­ча­ешь <a href="/media/pictures/torrent_ohmy.jpg">по­доб­ные пись­ма</a>, рас­сы­ла­е­мые по­лу­ав­то­ма­ти­че­ски­ми си­сте­ма­ми пра­во­за­щит­ных ище­ек, что не до­бав­ля­ет хо­ро­ше­го на­стро­е­ния в твой и так не осо­бо ве­се­лый ра­бо­чий день. Ка­ким об­ра­зом они от­сле­жи­ва­ют по­пыт­ку ска­чи­ва­ния тор­рен­та? Fake Seed к при­ме­ру? Или про­сто филь­тру­ют за­про­сы к тор­рент тре­ке­рам? Я без по­ня­тия, но вот если пра­виль­ным об­ра­зом не сре­а­ги­ро­вать на по­доб­ное пись­мо, убе­див хо­сте­ра, что этот му­дак, ка­ча­ю­щий Спан­ж­бо­ба, фи­зи­че­ски устра­нен, а вся его се­мья&nbsp;сте­ри­ли­зо­ва­на&nbsp;- мож­но по­лу­чить се­рьез­ные про­бле­мы. Вплоть да­же до су­деб­но­го раз­би­ра­тель­ства, все мы но­во­сти чи­та­ем. Это про­бле­ма, те­перь по­го­во­рим о ре­ше­нии. Лю­бой си­стем­ный ад­ми­ни­стра­тор ска­жет вам, что не су­ще­ству­ет оп­ти­маль­но­го ре­ше­ния пе­ре­кры­тия кис­ло­ро­да p2p тра­фи­ку. Да, мож­но огра­ни­чи­вать ко­ли­че­ство udp сес­сий од­но­го хо­ста (что до­ста­точ­но глу­пое ре­ше­ние, учи­ты­вая са­му при­ро­ду про­то­ко­ла с не­яв­ным за­кры­ти­ем со­еди­не­ния), мож­но во­об­ще за­крыть udp (что еще глу­пее, од­ним ма­хом ли­ша­ем поль­зо­ва­те­ля вся­ких скай­пов\си­пов, а тор­рент кли­ен­ты мо­гут спо­кой­но и че­рез TCP ра­бо­тать), мож­но ис­поль­зо­вать вся­кие мо­ду­ли филь­тра­ции уров­ня iptables вро­де ipp2p, OpenDPI, l7-filter (на сай­те пи­шут про вы­со­кий perfomance, но у ме­ня la вска­ки­вал до 1 при 10 со­еди­не­ни­ях и ино­гда всплы­ва­ли defunct зом­би) или во­об­ще пус­кать весь тра­фик OpenVPN &nbsp;в лоб че­рез филь­тру­ю­щий прок­си сер­вер (мною бы­ло опро­бо­ва­но все из спис­ка, увы, все ре­ше­ния край­не тре­бо­ва­тель­ны к си­стем­ным ре­сур­са­ми из-за не­об­хо­ди­мо­сти про­че­сы­ва­ния ре­гу­ляр­ка­ми боль­шо­го по­то­ка дан­ных и по этой при­чи­не не по­до­шли, не все сер­ве­ра в се­ти мог­ли поз­во­лить се­бе та­кую рос­кошь). Есть еще ре­ше­ния для ду­ра­ков: за­кры­тие ти­пич­ных пор­тов, что не ра­бо­та­ет в усло­ви­ях со­вре­мен­ных кли­ен­тов и тот ва­ри­ант, ко­то­рый вы­брал я - DNS бло­ки­ров­ка глав­ных тор­рент тре­ке­ров. За­щи­та ужас­ная, ни­что не ме­ша­ет кли­ен­ту по­сле под­клю­че­ния вы­ста­вить вме­сто&nbsp;при­сва­и­ва­е­мо­го&nbsp;нейм­сер­ве­ра ка­кой-то дру­гой, дан­ное ре­ше­ние к то­му же не по­мо­га­ет, если поль­зо­ва­тель на­чал ска­чи­ва­ние тор­рен­та до под­клю­че­ния к на­ше­му VPN-у (хо­тя моя прак­ти­ка по­ка­зы­ва­ет, что в та­ких слу­ча­ях пра­во­за­щит­ные ищей­ки мол­чат, что еще раз слу­жит под­твер­жде­ни­ем кон­спи­ро­ло­ги­че­ской те­о­рии, что софт ко­пи­рай­те­ров про­сто от­сле­жи­ва­ет announce за­про­сы к тре­ке­рам), и ко­неч­но же дан­ный ва­ри­ант не спа­са­ет от DHT, ко­то­ро­му во­об­ще ни­че­го не нуж­но: ни тре­ке­ры, ни дн­сы. Но ра­бо­та­ет же, ко­ли­че­ство пи­сем от пра­во­обла­да­те­лей со­кра­ти­лось до 1-2х за 3 ме­ся­ца, воз­вра­ща­ем NXDOMAIN для всех до­мен­ных имен в бле­кли­сте и жи­вем при­пе­ва­ючи. Кста­ти, если кто име­ет идеи, как по­бо­роть bittorrent в се­ти - скинь­те мне хоть па­ру строк на mail@smirnoff.sumy.ua, чтоб я при­мер­но знал, ку­да ко­пать. С ме­ня бла­го­дар­но­сти в при­ем­ном для вас эк­ви­ва­лен­те.<p>Воз­вра­ща­ем­ся к те­ме ре­а­ли­за­ции. Преж­де все­го, от­ве­чаю на во­прос: за­чем мне нуж­но мно­го нейм­сер­ве­ров, а не один цен­траль­ный без всех этих за­мо­ро­чек с MySQL и т.д. В ка­че­стве master мы бу­дем ис­поль­зо­вать Google Public DNS, на нем был&nbsp;за­ме­чен load balancing для не­ко­то­рых круп­ных сай­тов, на за­прос по то­му же юту­бу с раз­ных гео­гра­фи­че­ских то­чек от­да­ва­лись раз­ные A-за­пи­си. К то­му же, про­во­дить NS query с&nbsp;гон­конг­ско­го&nbsp;сер­ве­ра че­рез тун­нель на цен­траль­ный сер­вер где-то в Люк­сем­бур­ге или США - очень мед­лен­но, по­это­му на­ши DNS-ы бу­дут от­ве­чать по то­му же ад­ре­су, что и шлюз. Язы­ком ре­а­ли­за­ции стал Perl. По­че­му? Да про­сто в нем есть все не­об­хо­ди­мые нам ком­по­нен­ты. Ис­поль­зо­вать мы бу­дем&nbsp;<a href="http://search.cpan.org/~olaf/Net-DNS-0.66/lib/Net/DNS.pm">Net::DNS</a> для ре­зол­ве­ра и&nbsp;<a href="http://search.cpan.org/dist/Net-DNS/lib/Net/DNS/Nameserver.pm">Net::DNS::Nameserver</a> для сер­ве­ра. Ра­зу­ме­ет­ся, без ке­ши­ро­ва­ния ни­ку­да. В ка­че­стве ре­ше­ния я со­ве­тую смот­реть в сто­ро­ну&nbsp;<a href="http://search.cpan.org/~BENNIE/Cache-Bounded/lib/Cache/Bounded.pm">Cache::Bounded</a>, ко­то­рое яв­ля­ет­ся по су­ти оберт­кой во­круг&nbsp;<a href="http://search.cpan.org/~JSWARTZ/Cache-Cache/lib/Cache/MemoryCache.pm">Cache::MemoryCache</a>&nbsp;с оп­ти­ми­за­ци­ей и об­ну­ле­ни­ем ке­ша по до­сти­же­нию опре­де­лен­но­го раз­ме­ра, что спа­сет нас от пе­ре­пол­не­ния па­мя­ти. В ре­зуль­та­те по­лу­чи­лось что-то вро­де <a href="/media/copypaste/nsfilter.pl">та­ко­го ко­да</a>. Сра­зу за­ме­чу, что 3 цик­ла for при чте­нии от­ве­та из ке­ша - не­объ­яс­ни­мая мною ми­сти­ка. Ка­за­лось бы с по­мо­щью тех же эле­мен­тов ис­ход­но­го мас­си­ва пу­тем пе­ре­бо­ра фор­ми­ру­ем но­вый, а вот про­стое при­сва­и­ва­ние - не ра­бо­та­ет. И хоть ты трес­ни. По ско­ро­сти впол­не нор­маль­но, пер­вый за­прос ко­неч­но от­ни­ма­ет опре­де­лен­ное вре­мя, но в даль­ней­шем из ке­ша в па­мя­ти все чи­та­ет­ся очень бы­стро. В ка­че­стве бо­ну­са, дер­жи­те <a href="/media/etc/torrent_trackers.zip">спи­сок</a> из 1800 са­мых круп­ных тор­рент тре­ке­ров для бло­ки­ров­ки.</p><p>Как по мне, сер­ви­сы vpn тун­не­лей долж­ны слу­жить ис­клю­чи­тель­но 2м це­лям: ска­чи­ва­ние тор­рен­тов в стра­нах, где за это на­хо­дят и бьют по ру­кам; и про­смотр ка­то­ли­че­ски­ми свя­щен­ни­ка­ми дет­ской пор­но­гра­фии там, где это то­же не осо­бо при­вет­ству­ет­ся. Пер­вых слу­ча­ев ста­но­вит­ся все боль­ше, а по­след­них - все мень­ше. Мы же на­шим TOS-ом за­пре­ща­ем основ­ные при­о­ри­тет­ные на­прав­ле­ния. А все осталь­ные ис­то­рии с &nbsp;за­щи­той ва­шей ин­фор­ма­ции, все это сказ­ки для де­тей. Мы то с ва­ми зна­ем, что от па­яль­ни­ка еще ни один фа­ер­волл или ка­нал с шиф­ро­ва­ни­ем не спа­сал.&nbsp;</p>
        </div>
    </article>

    <hr>

    <footer class="footer hidden-print">
        <p>Что делать, если вы все прочитали и вам понравилось? Можете посмотреть мои остальные статьи в <a href="/blog/archive/">архиве</a> или поделиться радостью со своими воображаемыми друзьями в социальных сетях: <span class="social"><a target="_blank" href="http://www.facebook.com/sharer.php?u=https%3A//www.mindcollapse.com/blog/254.html">фейсбук</a>, <a target="_blank" href="http://twitter.com/share?url=https%3A//www.mindcollapse.com/blog/254.html&amp;text=%D0%9F%D0%B8%D1%88%D0%B5%D0%BC%20%D1%81%D0%B2%D0%BE%D0%B9%20caching%20nameserver%20%D1%81%20%D1%84%D0%B8%D0%BB%D1%8C%D1%82%D1%80%D0%B0%D1%86%D0%B8%D0%B5%D0%B9&amp;via=middlesizetit">твиттер</a>, <a target="_blank" href="http://vkontakte.ru/share.php?url=https%3A//www.mindcollapse.com/blog/254.html">вконтакте</a></span>.</p>
    </footer>

    </main>   
</body>

</html>
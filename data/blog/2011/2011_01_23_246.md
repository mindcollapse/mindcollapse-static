Прежде всего, хочу заметить, что данная статья не претендует ни на уникальность, ни на технологические инновации тем более - использовать мы будем все готовое. Просто в какой-то момент мне стала интересна тема создания своего собственного аналога <a href="https://www.dropbox.com">Dropbox</a>-а, поэтому я решил поделиться с вами результатом, который можно использовать исключительно для тестов или дальнейших разработок. Ни я, ни создатели unison ничего вам гарантировать не можем, но об этом чуть ниже. Кто не в курсе, Dropbox - великолепнейший стартап из всех ныне существующих, позволяет синхронизировать свои файлы с удаленным хранилищем в облаках Amazon S3. Абсолютно бесплатно можно получить 2GB, а если зарегистрироваться по <a href="http://db.tt/pcQvkUx">моей реферальной ссылке</a>, то нам обоим еще накинет по 250MB. Вроде и мелочь, а приятно. Реклама рекламой, но давайте перейдем к техническому описанию.<p></p><p>Делать свой алгоритм для diff с последующим push-pull изменений мы не будем - это сложно и бесперспективно, а возьмем мы готовое решение для синхронизации локальной и удаленной директории под названием <a href="http://www.cis.upenn.edu/~bcpierce/unison/">Unison</a>. Очень, кстати, неплохое решение, кросплатформенное, собрано под windows, linux и macos, простое в настройке и достаточно быстрое. Есть, правда, и свои недостатки, при переименовании файла в local folder идет удаление его на remote директории с последующей перезаливкой, возможно, это как-то лечится настройками, при поверхностном прочтении я подобной информации не нашел. Unison требует наличие бинарника на клиенте-сервере (важный момент, версии обязательно должны совпадать) и может работать в виде сокет-демона (не подходит нам из соображений безопасности, отсутствует аутентификация), поверх rsync или ssh. Мы будем использовать последний вариант для удобства ограничения доступа, отсутствия проблем с правами доступа, безопасной передачи и кучи других преимуществ, которые дает нам secure shell protocol. Следующая трудность состоит в том, что usinon требует бинарник openssh клиента для своей работы, а мы в настоящий момент пишем клиент для windows, не забывайте. Разумеется, ничто не мешает взять cygwin скомпилированную версию, но она у меня как-то криво работала, не поддерживала интерактивную авторизацию логином и паролем, и не давала логиниться через rsa_key, рассказывая про insecure file permission, требуя chmod-ить его в 0600, а как, простите, я это в окнах сделаю? Благо, существует нативная CLI версия <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html">PuTTY SSH Client</a> под названием Plink.exe, которую мы и будем использовать. Прямое переименование plink.exe в ssh.exe работать не будет, plink не поддерживает некоторые атрибуты и отваливается с ошибкой. В интернете была найдена обертка, которая исправляет данный недостаток. Это обычный bat файл, его содержание <a href="/media/copypaste/ssh2plink.bat">можно посмотреть</a>. Все, теперь ничего не мешает вам использовать двустороннюю синхронизацию с помощью команды <em>unison.exe C:\local\path\ ssh://host.com/remote/path/ -batch -sshcmd ssh2plink.bat -sshargs "-pw mysshpass -l mysshlogin</em>". Если вы переживаете за безопасность, то можно настроить и passwordless авторизацию. Для это генерируйте ключ на сервере, конвертируйте его в ppk формат, который использует PuTTY, c помощью PuTTYgen и говорите Plink-у использовать этот файл через<em> -sshargs "-i pathtomykey.ppk -l mysshlogin</em>". <p></p><p>На этом казалось бы можно было закончить, но мы же хотим аналог дропбокса, весь кайф которого заключается в immediate synchronization: открыли файл, отредактировали его, сохранили и он сразу же протолкнулся на сервер. Вот тут нам не обойтись уже без клиента, писать его мы будем на Microsoft Visual C# Express. Почему? Да просто мне так удобно, к тому же в нем по умолчанию есть все необходимые нам инструменты. Основные классы, которые мы будем использовать: System.Diagnostics.Process для работы с unison.exe и его StandardOutput (который почему-то у меня отдавался в StandardError, несмотря на 0 ExitCode процесса), System.IO.FileSystemWatcher для отслеживания изменений в директории и System.ComponentModel.BackgroundWorker для работы в фоне. Набросанный на скорую руку код выглядит <a href="/media/copypaste/sshbox.cs">следующим образом</a>. Ну или вот <a href="/media/etc/sshbox.zip">весь проект</a> для сборки. А вот готовый <a href="/media/etc/sshbox_bin.zip">бинарник</a>. Повторюсь, все это делалось на скорую руку, но может стать базой для нормального проекта, если вам это так интересно. Да, кстати, usinon поддерживает мультиклиентную синхронизацию с топологией вида звезда, так что, если добавить таймер для синхронизации, то тут вам и возможность работать целым кодлом над одним файлом, правда я подобное не тестировал.</p><p></p><p>Таким образом, для настройки своего сервера синхронизации вам нужен удаленный linux\freebsd сервер с рутом или хотя бы возможностью собирать бинарники, одинаковые версии unison на обоих концах (достаточно x.xx.000, версия билда 000 никак не влияет на совместимость), обертка для отслеживания изменений и вы получаете свой аналог Dropbox. Я повторюсь, аналог, который выполняет лишь 50% функций оригинала, но тем не менее может стать заменой людям, которые не доверяют свои файлики никому, а весь /home у них монтируется в EncFS.</p></p>